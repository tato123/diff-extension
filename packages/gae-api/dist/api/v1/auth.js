"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.renewSession = exports.codeGrantAuthorize = exports.refresh = exports.login = void 0;

var _expressJwt = _interopRequireDefault(require("express-jwt"));

var _jwksRsa = _interopRequireDefault(require("jwks-rsa"));

var _firestore = require("../../firestore");

var _logging = _interopRequireDefault(require("../../logging"));

var userCollection = _interopRequireWildcard(require("../../firestore/users"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const request = require('request');

const config = {
  AUTH0_DOMAIN: process.env.AUTH0_DOMAIN,
  AUTH0_API_AUDIENCE: process.env.AUTH0_API_AUDIENCE
}; // Auth0 athentication middleware

const jwtCheck = (0, _expressJwt.default)({
  secret: _jwksRsa.default.expressJwtSecret({
    cache: true,
    rateLimit: true,
    jwksRequestsPerMinute: 5,
    jwksUri: `https://${config.AUTH0_DOMAIN}/.well-known/jwks.json`
  }),
  // audience: config.AUTH0_API_AUDIENCE,
  issuer: `https://${config.AUTH0_DOMAIN}/`,
  algorithm: 'RS256'
});

const userProfileSync = async (req, res, next) => {
  _logging.default.info('------------[first-time check] ----------');

  console.log('user is', req.user.sub);

  const userRef = _firestore.db.collection('users').doc(req.user.sub);

  const userDoc = await userRef.get();

  if (userDoc.exists) {
    console.log('Syncing profile information');
    await userRef.update(req.user);
  } else {
    console.log('user does not exists');
    await userCollection.registerUser(req.user);
  }

  console.log(req.user);

  _logging.default.info('-----------------------------------------');

  next();
}; // GET object containing Firebase custom token


const login = [jwtCheck, userProfileSync, (req, res) => {
  // Create UID from authenticated Auth0 user
  const uid = req.user.sub;

  _logging.default.debug(`JWT check uid ${JSON.stringify(req.user)}`); // Mint token using Firebase Admin SDK


  _firestore.admin.auth().createCustomToken(uid).then(customToken => {
    _logging.default.debug(`Firebase custom token for ${customToken}`); // Response must be an object or Firebase errors


    return res.json({
      firebaseToken: customToken
    });
  }).catch(err => res.status(500).send({
    message: 'Something went wrong acquiring a Firebase token.',
    error: err
  }));
}];
exports.login = login;

const refresh = (req, res) => {
  const {
    query: {
      refreshToken
    }
  } = req;

  if (!refreshToken) {
    res.send(401, 'refresh token required');
  }

  _logging.default.debug(`Refreshing token for ${refreshToken}`);

  const options = {
    method: 'POST',
    url: `https://${process.env.AUTH0_DOMAIN}/oauth/token`,
    headers: {
      'content-type': 'application/json'
    },
    body: {
      grant_type: 'refresh_token',
      client_id: process.env.AUTH0_CLIENTID,
      client_secret: process.env.AUTH0_CLIENT_SECRET,
      refresh_token: refreshToken
    },
    json: true
  };
  request(options, (error, response, body) => {
    if (error) {
      res.send(401);
    }

    res.send(200, body);
  });
};

exports.refresh = refresh;
const codeGrantAuthorize = [(req, res, next) => {
  const {
    query: {
      code,
      redirectUri
    }
  } = req;
  const options = {
    method: 'POST',
    url: `https://${process.env.AUTH0_DOMAIN}/oauth/token`,
    headers: {
      'content-type': 'application/json'
    },
    body: {
      grant_type: 'authorization_code',
      client_id: process.env.AUTH0_CLIENTID,
      client_secret: process.env.AUTH0_CLIENT_SECRET,
      code,
      redirect_uri: redirectUri
    },
    json: true
  };
  request(options, (error, response, body) => {
    if (error) {
      next(error);
    }

    req.headers.authorization = `Bearer ${body.id_token}`;
    req._user = body;
    next();
  });
}, jwtCheck, userProfileSync, (req, res) => {
  res.status(200).send(req._user);
}];
exports.codeGrantAuthorize = codeGrantAuthorize;

const renewSession = async (req, res) => {
  const {
    query: {
      refreshToken
    }
  } = req;

  if (!refreshToken) {
    res.send(401, 'A refresh token is required');
  }

  const options = {
    method: 'POST',
    url: `https://${process.env.AUTH0_DOMAIN}/oauth/token`,
    headers: {
      'content-type': 'application/json'
    },
    body: {
      grant_type: 'refresh_token',
      client_id: process.env.AUTH0_CLIENTID,
      client_secret: process.env.AUTH0_CLIENT_SECRET,
      refresh_token: refreshToken
    },
    json: true
  };
  request(options, (error, response, body) => {
    if (error) {
      return res.send(403, error);
    }

    return res.send(200, body);
  });
};

exports.renewSession = renewSession;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvdjEvYXV0aC5qcyJdLCJuYW1lcyI6WyJyZXF1ZXN0IiwicmVxdWlyZSIsImNvbmZpZyIsIkFVVEgwX0RPTUFJTiIsInByb2Nlc3MiLCJlbnYiLCJBVVRIMF9BUElfQVVESUVOQ0UiLCJqd3RDaGVjayIsInNlY3JldCIsImp3a3MiLCJleHByZXNzSnd0U2VjcmV0IiwiY2FjaGUiLCJyYXRlTGltaXQiLCJqd2tzUmVxdWVzdHNQZXJNaW51dGUiLCJqd2tzVXJpIiwiaXNzdWVyIiwiYWxnb3JpdGhtIiwidXNlclByb2ZpbGVTeW5jIiwicmVxIiwicmVzIiwibmV4dCIsImxvZ2dpbmciLCJpbmZvIiwiY29uc29sZSIsImxvZyIsInVzZXIiLCJzdWIiLCJ1c2VyUmVmIiwiZGIiLCJjb2xsZWN0aW9uIiwiZG9jIiwidXNlckRvYyIsImdldCIsImV4aXN0cyIsInVwZGF0ZSIsInVzZXJDb2xsZWN0aW9uIiwicmVnaXN0ZXJVc2VyIiwibG9naW4iLCJ1aWQiLCJkZWJ1ZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJhZG1pbiIsImF1dGgiLCJjcmVhdGVDdXN0b21Ub2tlbiIsInRoZW4iLCJjdXN0b21Ub2tlbiIsImpzb24iLCJmaXJlYmFzZVRva2VuIiwiY2F0Y2giLCJlcnIiLCJzdGF0dXMiLCJzZW5kIiwibWVzc2FnZSIsImVycm9yIiwicmVmcmVzaCIsInF1ZXJ5IiwicmVmcmVzaFRva2VuIiwib3B0aW9ucyIsIm1ldGhvZCIsInVybCIsImhlYWRlcnMiLCJib2R5IiwiZ3JhbnRfdHlwZSIsImNsaWVudF9pZCIsIkFVVEgwX0NMSUVOVElEIiwiY2xpZW50X3NlY3JldCIsIkFVVEgwX0NMSUVOVF9TRUNSRVQiLCJyZWZyZXNoX3Rva2VuIiwicmVzcG9uc2UiLCJjb2RlR3JhbnRBdXRob3JpemUiLCJjb2RlIiwicmVkaXJlY3RVcmkiLCJyZWRpcmVjdF91cmkiLCJhdXRob3JpemF0aW9uIiwiaWRfdG9rZW4iLCJfdXNlciIsInJlbmV3U2Vz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QWNVLElBQWQsQ0FBUDtBQUNELEdBTk0sQ0FBUDtBQU9ELENBN0JNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGp3dCBmcm9tICdleHByZXNzLWp3dCc7XG5pbXBvcnQgandrcyBmcm9tICdqd2tzLXJzYSc7XG5cbmltcG9ydCB7IGFkbWluLCBkYiB9IGZyb20gJy4uLy4uL2ZpcmVzdG9yZSc7XG5pbXBvcnQgbG9nZ2luZyBmcm9tICcuLi8uLi9sb2dnaW5nJztcbmltcG9ydCAqIGFzIHVzZXJDb2xsZWN0aW9uIGZyb20gJy4uLy4uL2ZpcmVzdG9yZS91c2Vycyc7XG5cbmNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0Jyk7XG5cbmNvbnN0IGNvbmZpZyA9IHtcbiAgQVVUSDBfRE9NQUlOOiBwcm9jZXNzLmVudi5BVVRIMF9ET01BSU4sXG4gIEFVVEgwX0FQSV9BVURJRU5DRTogcHJvY2Vzcy5lbnYuQVVUSDBfQVBJX0FVRElFTkNFXG59O1xuXG4vLyBBdXRoMCBhdGhlbnRpY2F0aW9uIG1pZGRsZXdhcmVcbmNvbnN0IGp3dENoZWNrID0gand0KHtcbiAgc2VjcmV0OiBqd2tzLmV4cHJlc3NKd3RTZWNyZXQoe1xuICAgIGNhY2hlOiB0cnVlLFxuICAgIHJhdGVMaW1pdDogdHJ1ZSxcbiAgICBqd2tzUmVxdWVzdHNQZXJNaW51dGU6IDUsXG4gICAgandrc1VyaTogYGh0dHBzOi8vJHtjb25maWcuQVVUSDBfRE9NQUlOfS8ud2VsbC1rbm93bi9qd2tzLmpzb25gXG4gIH0pLFxuICAvLyBhdWRpZW5jZTogY29uZmlnLkFVVEgwX0FQSV9BVURJRU5DRSxcbiAgaXNzdWVyOiBgaHR0cHM6Ly8ke2NvbmZpZy5BVVRIMF9ET01BSU59L2AsXG4gIGFsZ29yaXRobTogJ1JTMjU2J1xufSk7XG5cbmNvbnN0IHVzZXJQcm9maWxlU3luYyA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICBsb2dnaW5nLmluZm8oJy0tLS0tLS0tLS0tLVtmaXJzdC10aW1lIGNoZWNrXSAtLS0tLS0tLS0tJyk7XG4gIGNvbnNvbGUubG9nKCd1c2VyIGlzJywgcmVxLnVzZXIuc3ViKTtcblxuICBjb25zdCB1c2VyUmVmID0gZGIuY29sbGVjdGlvbigndXNlcnMnKS5kb2MocmVxLnVzZXIuc3ViKTtcblxuICBjb25zdCB1c2VyRG9jID0gYXdhaXQgdXNlclJlZi5nZXQoKTtcblxuICBpZiAodXNlckRvYy5leGlzdHMpIHtcbiAgICBjb25zb2xlLmxvZygnU3luY2luZyBwcm9maWxlIGluZm9ybWF0aW9uJyk7XG4gICAgYXdhaXQgdXNlclJlZi51cGRhdGUocmVxLnVzZXIpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKCd1c2VyIGRvZXMgbm90IGV4aXN0cycpO1xuICAgIGF3YWl0IHVzZXJDb2xsZWN0aW9uLnJlZ2lzdGVyVXNlcihyZXEudXNlcik7XG4gIH1cbiAgY29uc29sZS5sb2cocmVxLnVzZXIpO1xuICBsb2dnaW5nLmluZm8oJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJyk7XG4gIG5leHQoKTtcbn07XG5cbi8vIEdFVCBvYmplY3QgY29udGFpbmluZyBGaXJlYmFzZSBjdXN0b20gdG9rZW5cbmV4cG9ydCBjb25zdCBsb2dpbiA9IFtcbiAgand0Q2hlY2ssXG4gIHVzZXJQcm9maWxlU3luYyxcbiAgKHJlcSwgcmVzKSA9PiB7XG4gICAgLy8gQ3JlYXRlIFVJRCBmcm9tIGF1dGhlbnRpY2F0ZWQgQXV0aDAgdXNlclxuICAgIGNvbnN0IHVpZCA9IHJlcS51c2VyLnN1YjtcbiAgICBsb2dnaW5nLmRlYnVnKGBKV1QgY2hlY2sgdWlkICR7SlNPTi5zdHJpbmdpZnkocmVxLnVzZXIpfWApO1xuICAgIC8vIE1pbnQgdG9rZW4gdXNpbmcgRmlyZWJhc2UgQWRtaW4gU0RLXG4gICAgYWRtaW5cbiAgICAgIC5hdXRoKClcbiAgICAgIC5jcmVhdGVDdXN0b21Ub2tlbih1aWQpXG4gICAgICAudGhlbihjdXN0b21Ub2tlbiA9PiB7XG4gICAgICAgIGxvZ2dpbmcuZGVidWcoYEZpcmViYXNlIGN1c3RvbSB0b2tlbiBmb3IgJHtjdXN0b21Ub2tlbn1gKTtcbiAgICAgICAgLy8gUmVzcG9uc2UgbXVzdCBiZSBhbiBvYmplY3Qgb3IgRmlyZWJhc2UgZXJyb3JzXG4gICAgICAgIHJldHVybiByZXMuanNvbih7IGZpcmViYXNlVG9rZW46IGN1c3RvbVRva2VuIH0pO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT5cbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLnNlbmQoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdTb21ldGhpbmcgd2VudCB3cm9uZyBhY3F1aXJpbmcgYSBGaXJlYmFzZSB0b2tlbi4nLFxuICAgICAgICAgIGVycm9yOiBlcnJcbiAgICAgICAgfSlcbiAgICAgICk7XG4gIH1cbl07XG5cbmV4cG9ydCBjb25zdCByZWZyZXNoID0gKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHtcbiAgICBxdWVyeTogeyByZWZyZXNoVG9rZW4gfVxuICB9ID0gcmVxO1xuXG4gIGlmICghcmVmcmVzaFRva2VuKSB7XG4gICAgcmVzLnNlbmQoNDAxLCAncmVmcmVzaCB0b2tlbiByZXF1aXJlZCcpO1xuICB9XG5cbiAgbG9nZ2luZy5kZWJ1ZyhgUmVmcmVzaGluZyB0b2tlbiBmb3IgJHtyZWZyZXNoVG9rZW59YCk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICB1cmw6IGBodHRwczovLyR7cHJvY2Vzcy5lbnYuQVVUSDBfRE9NQUlOfS9vYXV0aC90b2tlbmAsXG4gICAgaGVhZGVyczogeyAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sXG4gICAgYm9keToge1xuICAgICAgZ3JhbnRfdHlwZTogJ3JlZnJlc2hfdG9rZW4nLFxuICAgICAgY2xpZW50X2lkOiBwcm9jZXNzLmVudi5BVVRIMF9DTElFTlRJRCxcbiAgICAgIGNsaWVudF9zZWNyZXQ6IHByb2Nlc3MuZW52LkFVVEgwX0NMSUVOVF9TRUNSRVQsXG4gICAgICByZWZyZXNoX3Rva2VuOiByZWZyZXNoVG9rZW5cbiAgICB9LFxuICAgIGpzb246IHRydWVcbiAgfTtcblxuICByZXF1ZXN0KG9wdGlvbnMsIChlcnJvciwgcmVzcG9uc2UsIGJvZHkpID0+IHtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIHJlcy5zZW5kKDQwMSk7XG4gICAgfVxuXG4gICAgcmVzLnNlbmQoMjAwLCBib2R5KTtcbiAgfSk7XG59O1xuXG5leHBvcnQgY29uc3QgY29kZUdyYW50QXV0aG9yaXplID0gW1xuICAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBjb25zdCB7XG4gICAgICBxdWVyeTogeyBjb2RlLCByZWRpcmVjdFVyaSB9XG4gICAgfSA9IHJlcTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIHVybDogYGh0dHBzOi8vJHtwcm9jZXNzLmVudi5BVVRIMF9ET01BSU59L29hdXRoL3Rva2VuYCxcbiAgICAgIGhlYWRlcnM6IHsgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LFxuICAgICAgYm9keToge1xuICAgICAgICBncmFudF90eXBlOiAnYXV0aG9yaXphdGlvbl9jb2RlJyxcbiAgICAgICAgY2xpZW50X2lkOiBwcm9jZXNzLmVudi5BVVRIMF9DTElFTlRJRCxcbiAgICAgICAgY2xpZW50X3NlY3JldDogcHJvY2Vzcy5lbnYuQVVUSDBfQ0xJRU5UX1NFQ1JFVCxcbiAgICAgICAgY29kZSxcbiAgICAgICAgcmVkaXJlY3RfdXJpOiByZWRpcmVjdFVyaVxuICAgICAgfSxcbiAgICAgIGpzb246IHRydWVcbiAgICB9O1xuXG4gICAgcmVxdWVzdChvcHRpb25zLCAoZXJyb3IsIHJlc3BvbnNlLCBib2R5KSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgbmV4dChlcnJvcik7XG4gICAgICB9XG5cbiAgICAgIHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7Ym9keS5pZF90b2tlbn1gO1xuICAgICAgcmVxLl91c2VyID0gYm9keTtcbiAgICAgIG5leHQoKTtcbiAgICB9KTtcbiAgfSxcbiAgand0Q2hlY2ssXG4gIHVzZXJQcm9maWxlU3luYyxcbiAgKHJlcSwgcmVzKSA9PiB7XG4gICAgcmVzLnN0YXR1cygyMDApLnNlbmQocmVxLl91c2VyKTtcbiAgfVxuXTtcblxuZXhwb3J0IGNvbnN0IHJlbmV3U2Vzc2lvbiA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB7XG4gICAgcXVlcnk6IHsgcmVmcmVzaFRva2VuIH1cbiAgfSA9IHJlcTtcblxuICBpZiAoIXJlZnJlc2hUb2tlbikge1xuICAgIHJlcy5zZW5kKDQwMSwgJ0EgcmVmcmVzaCB0b2tlbiBpcyByZXF1aXJlZCcpO1xuICB9XG5cbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICB1cmw6IGBodHRwczovLyR7cHJvY2Vzcy5lbnYuQVVUSDBfRE9NQUlOfS9vYXV0aC90b2tlbmAsXG4gICAgaGVhZGVyczogeyAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sXG4gICAgYm9keToge1xuICAgICAgZ3JhbnRfdHlwZTogJ3JlZnJlc2hfdG9rZW4nLFxuICAgICAgY2xpZW50X2lkOiBwcm9jZXNzLmVudi5BVVRIMF9DTElFTlRJRCxcbiAgICAgIGNsaWVudF9zZWNyZXQ6IHByb2Nlc3MuZW52LkFVVEgwX0NMSUVOVF9TRUNSRVQsXG4gICAgICByZWZyZXNoX3Rva2VuOiByZWZyZXNoVG9rZW5cbiAgICB9LFxuICAgIGpzb246IHRydWVcbiAgfTtcblxuICByZXF1ZXN0KG9wdGlvbnMsIChlcnJvciwgcmVzcG9uc2UsIGJvZHkpID0+IHtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIHJldHVybiByZXMuc2VuZCg0MDMsIGVycm9yKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzLnNlbmQoMjAwLCBib2R5KTtcbiAgfSk7XG59O1xuIl19