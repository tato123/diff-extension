"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.emailListSignup = exports.getDomains = exports.createWorkspace = exports.inviteUsersToWorkspace = exports.verifyUser = exports.signup = exports.authenticate = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _mailgunJs = _interopRequireDefault(require("mailgun-js"));

var _userManager = _interopRequireDefault(require("../helpers/userManager"));

var _logging = _interopRequireDefault(require("../../logging"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const authenticate = (req, res) => {
  // check the headers
  if (req.headers.authorization && req.headers.authorization.toLowerCase().startsWith('basic')) {
    return _userManager.default.basicAuthentication(req, res);
  }

  if (!req.headers.authorization && req.body.indexOf('grant_type=refresh_token') !== -1) {
    return _userManager.default.tokenAuthentication(req, res);
  }
};

exports.authenticate = authenticate;

const signup = async (req, res) => {
  const {
    email,
    password,
    displayName
  } = req.body;

  if (!email || !password) {
    return res.send(400, {
      err: 'Email / password required to create an account'
    });
  }

  try {
    const token = await _userManager.default.signupUser(email, password, displayName);
    res.send(200, token);
  } catch (err) {
    res.send(400, {
      err: err.message
    });
  }
};

exports.signup = signup;

const verifyUser = async (req, res) => {
  const {
    email
  } = req.query;

  if (_lodash.default.isNil(email)) {
    return res.send(404, '');
  }

  try {
    const isValid = await _userManager.default.isUser(email);

    if (isValid) {
      return res.send(200);
    }

    return res.send(404);
  } catch (err) {
    res.send(404);
  }
};

exports.verifyUser = verifyUser;

const inviteUsersToWorkspace = async (req, res) => {
  const {
    emails,
    workspaceId
  } = req.body;
  const {
    authorization
  } = req.headers;

  try {
    const creatorUid = await _userManager.default.bearerToUid(authorization);

    if (!creatorUid) {
      return res.send(401, {
        message: 'Cannot invite user anonymously'
      });
    }

    await _userManager.default.inviteUsers(emails, workspaceId, creatorUid);
    res.send(200, {
      status: 'invited'
    });
  } catch (err) {
    res.send(400, {
      message: 'not invited'
    });
  }
};

exports.inviteUsersToWorkspace = inviteUsersToWorkspace;

const createWorkspace = async (req, res) => {
  const {
    name
  } = req.body;
  const {
    authorization
  } = req.headers;

  try {
    const creatorUid = await _userManager.default.bearerToUid(authorization);

    if (!creatorUid) {
      return res.send(401, {
        message: 'Cannot create workspace anonymously'
      });
    }

    const workspaceId = await _userManager.default.createWorkspace(name, creatorUid);
    res.send(200, {
      workspaceId
    });
  } catch (err) {
    res.send(400, {
      message: `Workspace not created: ${err.message}`
    });
  }
};

exports.createWorkspace = createWorkspace;

const getDomains = async (req, res) => {
  const refreshToken = req.params.token.value;

  if (!refreshToken) {
    return res.json({
      domains: []
    });
  }

  try {
    const domains = await _userManager.default.getDomains(refreshToken);
    res.json({
      domains
    });
  } catch (err) {
    res.json({
      message: err.message
    });
  }
};

exports.getDomains = getDomains;

const emailListSignup = (req, res) => {
  const {
    list
  } = req.query;
  const {
    firstname,
    lastname,
    email
  } = req.body;
  const apiKey = process.env.MAILGUN_API_KEY;
  const domain = process.env.MAILGUN_DOMAIN;
  const mailgun = new _mailgunJs.default({
    apiKey,
    domain
  });
  const maillist = mailgun.lists('early-access@mail.getdiff.app');
  const subscriber = {
    subscribed: true,
    address: email,
    name: `${firstname} ${lastname}`,
    vars: {}
  };
  maillist.members().create(subscriber).then(data => {
    _logging.default.debug(data);

    res.sendStatus(201);
  }).catch(err => {
    _logging.default.error(err.message);

    res.send(400, err.message);
  });
};

exports.emailListSignup = emailListSignup;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvdjEvdXNlci5qcyJdLCJuYW1lcyI6WyJhdXRoZW50aWNhdGUiLCJyZXEiLCJyZXMiLCJoZWFkZXJzIiwiYXV0aG9yaXphdGlvbiIsInRvTG93ZXJDYXNlIiwic3RhcnRzV2l0aCIsInVzZXJNYW5hZ2VyIiwiYmFzaWNBdXRoZW50aWNhdGlvbiIsImJvZHkiLCJpbmRleE9mIiwidG9rZW5BdXRoZW50aWNhdGlvbiIsInNpZ251cCIsImVtYWlsIiwicGFzc3dvcmQiLCJkaXNwbGF5TmFtZSIsInNlbmQiLCJlcnIiLCJ0b2tlbiIsInNpZ251cFVzZXIiLCJtZXNzYWdlIiwidmVyaWZ5VXNlciIsInF1ZXJ5IiwiXyIsImlzTmlsIiwiaXNWYWxpZCIsImlzVXNlciIsImludml0ZVVzZXJzVG9Xb3Jrc3BhY2UiLCJlbWFpbHMiLCJ3b3Jrc3BhY2VJZCIsImNyZWF0b3JVaWQiLCJiZWFyZXJUb1VpZCIsImludml0ZVVzZXJzIiwic3RhdHVzIiwiY3JlYXRlV29ya3NwYWNlIiwibmFtZSIsImdldERvbWFpbnMiLCJyZWZyZXNoVG9rZW4iLCJwYXJhbXMiLCJ2YWx1ZSIsImpzb24iLCJkb21haW5zIiwiZW1haWxMaXN0U2lnbnVwIiwibGlzdCIsImZpcnN0bmFtZSIsImxhc3RuYW1lIiwiYXBpS2V5IiwicHJvY2VzcyIsImVudiIsIk1BSUxHVU5fQVBJX0tFWSIsImRvbWFpbiIsIk1BSUxHVU5fRE9NQUlOIiwibWFpbGd1biIsIk1haWxndW4iLCJtYWlsbGlzdCIsImxpc3RzIiwic3Vic2NyaWJlciIsInN1YnNjcmliZWQiLCJhZGRyZXNzIiwidmFycyIsIm1lbWJlcnMiLCJjcmVhdGUiLCJ0aGVuIiwiZGF0YSIsImxvZ2dpbmciLCJkZWJ1ZyIsInNlbmRTdGF0dXMiLCJjYXRjaCIsImVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFTyxNQUFNQSxZQUFZLEdBQUcsQ0FBQ0MsR0FBRCxF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TUMsVUFBVSxHQUFHO0FBQ2pCQyxJQUFBQSxVQUFVLEVBQUUsSUFESztBQUVqQkMsSUFBQUEsT0FBTyxFQUFFN0MsS0FGUTtBQUdqQnNCLElBQUFBLElBQUksRUFBRyxHQUFFUyxTQUFVLElBQUdDLFFBQVMsRUFIZDtBQUlqQmMsSUFBQUEsSUFBSSxFQUFFO0FBSlcsR0FBbkI7QUFPQUwsRUFBQUEsUUFBUSxDQUNMTSxPQURILEdBRUdDLE1BRkgsQ0FFVUwsVUFGVixFQUdHTSxJQUhILENBR1FDLElBQUksSUFBSTtBQUNaQyxxQkFBUUMsS0FBUixDQUFjRixJQUFkOztBQUVBN0QsSUFBQUEsR0FBRyxDQUFDZ0UsVUFBSixDQUFlLEdBQWY7QUFDRCxHQVBILEVBUUdDLEtBUkgsQ0FRU2xELEdBQUcsSUFBSTtBQUNaK0MscUJBQVFJLEtBQVIsQ0FBY25ELEdBQUcsQ0FBQ0csT0FBbEI7O0FBQ0FsQixJQUFBQSxHQUFHLENBQUNjLElBQUosQ0FBUyxHQUFULEVBQWNDLEdBQUcsQ0FBQ0csT0FBbEI7QUFDRCxHQVhIO0FBWUQsQ0E3Qk0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IE1haWxndW4gZnJvbSAnbWFpbGd1bi1qcyc7XG5pbXBvcnQgdXNlck1hbmFnZXIgZnJvbSAnLi4vaGVscGVycy91c2VyTWFuYWdlcic7XG5pbXBvcnQgbG9nZ2luZyBmcm9tICcuLi8uLi9sb2dnaW5nJztcblxuZXhwb3J0IGNvbnN0IGF1dGhlbnRpY2F0ZSA9IChyZXEsIHJlcykgPT4ge1xuICAvLyBjaGVjayB0aGUgaGVhZGVyc1xuICBpZiAoXG4gICAgcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbiAmJlxuICAgIHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24udG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCdiYXNpYycpXG4gICkge1xuICAgIHJldHVybiB1c2VyTWFuYWdlci5iYXNpY0F1dGhlbnRpY2F0aW9uKHJlcSwgcmVzKTtcbiAgfVxuICBpZiAoXG4gICAgIXJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24gJiZcbiAgICByZXEuYm9keS5pbmRleE9mKCdncmFudF90eXBlPXJlZnJlc2hfdG9rZW4nKSAhPT0gLTFcbiAgKSB7XG4gICAgcmV0dXJuIHVzZXJNYW5hZ2VyLnRva2VuQXV0aGVudGljYXRpb24ocmVxLCByZXMpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3Qgc2lnbnVwID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkLCBkaXNwbGF5TmFtZSB9ID0gcmVxLmJvZHk7XG4gIGlmICghZW1haWwgfHwgIXBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIHJlcy5zZW5kKDQwMCwge1xuICAgICAgZXJyOiAnRW1haWwgLyBwYXNzd29yZCByZXF1aXJlZCB0byBjcmVhdGUgYW4gYWNjb3VudCdcbiAgICB9KTtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHRva2VuID0gYXdhaXQgdXNlck1hbmFnZXIuc2lnbnVwVXNlcihlbWFpbCwgcGFzc3dvcmQsIGRpc3BsYXlOYW1lKTtcbiAgICByZXMuc2VuZCgyMDAsIHRva2VuKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmVzLnNlbmQoNDAwLCB7IGVycjogZXJyLm1lc3NhZ2UgfSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCB2ZXJpZnlVc2VyID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHsgZW1haWwgfSA9IHJlcS5xdWVyeTtcbiAgaWYgKF8uaXNOaWwoZW1haWwpKSB7XG4gICAgcmV0dXJuIHJlcy5zZW5kKDQwNCwgJycpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBpc1ZhbGlkID0gYXdhaXQgdXNlck1hbmFnZXIuaXNVc2VyKGVtYWlsKTtcbiAgICBpZiAoaXNWYWxpZCkge1xuICAgICAgcmV0dXJuIHJlcy5zZW5kKDIwMCk7XG4gICAgfVxuICAgIHJldHVybiByZXMuc2VuZCg0MDQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXMuc2VuZCg0MDQpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgaW52aXRlVXNlcnNUb1dvcmtzcGFjZSA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB7IGVtYWlscywgd29ya3NwYWNlSWQgfSA9IHJlcS5ib2R5O1xuICBjb25zdCB7IGF1dGhvcml6YXRpb24gfSA9IHJlcS5oZWFkZXJzO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgY3JlYXRvclVpZCA9IGF3YWl0IHVzZXJNYW5hZ2VyLmJlYXJlclRvVWlkKGF1dGhvcml6YXRpb24pO1xuICAgIGlmICghY3JlYXRvclVpZCkge1xuICAgICAgcmV0dXJuIHJlcy5zZW5kKDQwMSwgeyBtZXNzYWdlOiAnQ2Fubm90IGludml0ZSB1c2VyIGFub255bW91c2x5JyB9KTtcbiAgICB9XG4gICAgYXdhaXQgdXNlck1hbmFnZXIuaW52aXRlVXNlcnMoZW1haWxzLCB3b3Jrc3BhY2VJZCwgY3JlYXRvclVpZCk7XG4gICAgcmVzLnNlbmQoMjAwLCB7XG4gICAgICBzdGF0dXM6ICdpbnZpdGVkJ1xuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXMuc2VuZCg0MDAsIHsgbWVzc2FnZTogJ25vdCBpbnZpdGVkJyB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZVdvcmtzcGFjZSA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB7IG5hbWUgfSA9IHJlcS5ib2R5O1xuICBjb25zdCB7IGF1dGhvcml6YXRpb24gfSA9IHJlcS5oZWFkZXJzO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgY3JlYXRvclVpZCA9IGF3YWl0IHVzZXJNYW5hZ2VyLmJlYXJlclRvVWlkKGF1dGhvcml6YXRpb24pO1xuICAgIGlmICghY3JlYXRvclVpZCkge1xuICAgICAgcmV0dXJuIHJlcy5zZW5kKDQwMSwgeyBtZXNzYWdlOiAnQ2Fubm90IGNyZWF0ZSB3b3Jrc3BhY2UgYW5vbnltb3VzbHknIH0pO1xuICAgIH1cbiAgICBjb25zdCB3b3Jrc3BhY2VJZCA9IGF3YWl0IHVzZXJNYW5hZ2VyLmNyZWF0ZVdvcmtzcGFjZShuYW1lLCBjcmVhdG9yVWlkKTtcbiAgICByZXMuc2VuZCgyMDAsIHtcbiAgICAgIHdvcmtzcGFjZUlkXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJlcy5zZW5kKDQwMCwgeyBtZXNzYWdlOiBgV29ya3NwYWNlIG5vdCBjcmVhdGVkOiAke2Vyci5tZXNzYWdlfWAgfSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBnZXREb21haW5zID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHJlZnJlc2hUb2tlbiA9IHJlcS5wYXJhbXMudG9rZW4udmFsdWU7XG4gIGlmICghcmVmcmVzaFRva2VuKSB7XG4gICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgIGRvbWFpbnM6IFtdXG4gICAgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IGRvbWFpbnMgPSBhd2FpdCB1c2VyTWFuYWdlci5nZXREb21haW5zKHJlZnJlc2hUb2tlbik7XG4gICAgcmVzLmpzb24oe1xuICAgICAgZG9tYWluc1xuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXMuanNvbih7XG4gICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZVxuICAgIH0pO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgZW1haWxMaXN0U2lnbnVwID0gKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHsgbGlzdCB9ID0gcmVxLnF1ZXJ5O1xuICBjb25zdCB7IGZpcnN0bmFtZSwgbGFzdG5hbWUsIGVtYWlsIH0gPSByZXEuYm9keTtcblxuICBjb25zdCBhcGlLZXkgPSBwcm9jZXNzLmVudi5NQUlMR1VOX0FQSV9LRVk7XG4gIGNvbnN0IGRvbWFpbiA9IHByb2Nlc3MuZW52Lk1BSUxHVU5fRE9NQUlOO1xuXG4gIGNvbnN0IG1haWxndW4gPSBuZXcgTWFpbGd1bih7IGFwaUtleSwgZG9tYWluIH0pO1xuICBjb25zdCBtYWlsbGlzdCA9IG1haWxndW4ubGlzdHMoJ2Vhcmx5LWFjY2Vzc0BtYWlsLmdldGRpZmYuYXBwJyk7XG5cbiAgY29uc3Qgc3Vic2NyaWJlciA9IHtcbiAgICBzdWJzY3JpYmVkOiB0cnVlLFxuICAgIGFkZHJlc3M6IGVtYWlsLFxuICAgIG5hbWU6IGAke2ZpcnN0bmFtZX0gJHtsYXN0bmFtZX1gLFxuICAgIHZhcnM6IHt9XG4gIH07XG5cbiAgbWFpbGxpc3RcbiAgICAubWVtYmVycygpXG4gICAgLmNyZWF0ZShzdWJzY3JpYmVyKVxuICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgbG9nZ2luZy5kZWJ1ZyhkYXRhKTtcblxuICAgICAgcmVzLnNlbmRTdGF0dXMoMjAxKTtcbiAgICB9KVxuICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgbG9nZ2luZy5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICByZXMuc2VuZCg0MDAsIGVyci5tZXNzYWdlKTtcbiAgICB9KTtcbn07XG4iXX0=