"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.emailListSignup = exports.getDomains = exports.createWorkspace = exports.inviteUsersToWorkspace = exports.verifyUser = exports.signup = exports.authenticate = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _mailgunJs = _interopRequireDefault(require("mailgun-js"));

var _userManager = _interopRequireDefault(require("../helpers/userManager"));

var _logging = _interopRequireDefault(require("../../logging"));

var _email = _interopRequireDefault(require("../../email"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const authenticate = (req, res) => {
  // check the headers
  if (req.headers.authorization && req.headers.authorization.toLowerCase().startsWith('basic')) {
    return _userManager.default.basicAuthentication(req, res);
  }

  if (!req.headers.authorization && req.body.indexOf('grant_type=refresh_token') !== -1) {
    return _userManager.default.tokenAuthentication(req, res);
  }
};

exports.authenticate = authenticate;

const signup = async (req, res) => {
  const {
    email,
    password,
    displayName
  } = req.body;

  if (!email || !password) {
    return res.send(400, {
      err: 'Email / password required to create an account'
    });
  }

  try {
    const token = await _userManager.default.signupUser(email, password, displayName);
    res.send(200, token);
  } catch (err) {
    res.send(400, {
      err: err.message
    });
  }
};

exports.signup = signup;

const verifyUser = async (req, res) => {
  const {
    email
  } = req.query;

  if (_lodash.default.isNil(email)) {
    return res.send(404, '');
  }

  try {
    const isValid = await _userManager.default.isUser(email);

    if (isValid) {
      return res.send(200);
    }

    return res.send(404);
  } catch (err) {
    res.send(404);
  }
};

exports.verifyUser = verifyUser;

const inviteUsersToWorkspace = async (req, res) => {
  const {
    emails,
    workspaceId
  } = req.body;
  const {
    authorization
  } = req.headers;

  try {
    const creatorUid = await _userManager.default.bearerToUid(authorization);

    if (!creatorUid) {
      return res.send(401, {
        message: 'Cannot invite user anonymously'
      });
    }

    await _userManager.default.inviteUsers(emails, workspaceId, creatorUid);
    res.send(200, {
      status: 'invited'
    });
  } catch (err) {
    res.send(400, {
      message: 'not invited'
    });
  }
};

exports.inviteUsersToWorkspace = inviteUsersToWorkspace;

const createWorkspace = async (req, res) => {
  const {
    name
  } = req.body;
  const {
    authorization
  } = req.headers;

  try {
    const creatorUid = await _userManager.default.bearerToUid(authorization);

    if (!creatorUid) {
      return res.send(401, {
        message: 'Cannot create workspace anonymously'
      });
    }

    const workspaceId = await _userManager.default.createWorkspace(name, creatorUid);
    res.send(200, {
      workspaceId
    });
  } catch (err) {
    res.send(400, {
      message: `Workspace not created: ${err.message}`
    });
  }
};

exports.createWorkspace = createWorkspace;

const getDomains = async (req, res) => {
  const refreshToken = req.params.token.value;

  if (!refreshToken) {
    return res.json({
      domains: []
    });
  }

  try {
    const domains = await _userManager.default.getDomains(refreshToken);
    res.json({
      domains
    });
  } catch (err) {
    res.json({
      message: err.message
    });
  }
};

exports.getDomains = getDomains;

const emailListSignup = async (req, res) => {
  const {
    list,
    feature
  } = req.query;
  const {
    firstname,
    lastname,
    email
  } = req.body;
  const apiKey = process.env.MAILGUN_API_KEY;
  const domain = process.env.MAILGUN_DOMAIN;
  const mailgun = new _mailgunJs.default({
    apiKey,
    domain
  });
  const maillist = mailgun.lists('early-access@mail.getdiff.app');
  const subscriber = {
    subscribed: true,
    address: email,
    name: `${firstname} ${lastname}`,
    vars: {
      feature,
      list
    }
  };
  maillist.members().create(subscriber).then(data => {
    _logging.default.debug(data);

    return _email.default.signupEmail({
      to: email,
      name: firstname
    });
  }).then(() => res.sendStatus(201)).catch(err => {
    _logging.default.error(err.message);

    res.send(400, err.message);
  });
};

exports.emailListSignup = emailListSignup;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvdjEvdXNlci5qcyJdLCJuYW1lcyI6WyJhdXRoZW50aWNhdGUiLCJyZXEiLCJyZXMiLCJoZWFkZXJzIiwiYXV0aG9yaXphdGlvbiIsInRvTG93ZXJDYXNlIiwic3RhcnRzV2l0aCIsInVzZXJNYW5hZ2VyIiwiYmFzaWNBdXRoZW50aWNhdGlvbiIsImJvZHkiLCJpbmRleE9mIiwidG9rZW5BdXRoZW50aWNhdGlvbiIsInNpZ251cCIsImVtYWlsIiwicGFzc3dvcmQiLCJkaXNwbGF5TmFtZSIsInNlbmQiLCJlcnIiLCJ0b2tlbiIsInNpZ251cFVzZXIiLCJtZXNzYWdlIiwidmVyaWZ5VXNlciIsInF1ZXJ5IiwiXyIsImlzTmlsIiwiaXNWYWxpZCIsImlzVXNlciIsImludml0ZVVzZXJzVG9Xb3Jrc3BhY2UiLCJlbWFpbHMiLCJ3b3Jrc3BhY2VJZCIsImNyZWF0b3JVaWQiLCJiZWFyZXJUb1VpZCIsImludml0ZVVzZXJzIiwic3RhdHVzIiwiY3JlYXRlV29ya3NwYWNlIiwibmFtZSIsImdldERvbWFpbnMiLCJyZWZyZXNoVG9rZW4iLCJwYXJhbXMiLCJ2YWx1ZSIsImpzb24iLCJkb21haW5zIiwiZW1haWxMaXN0U2lnbnVwIiwibGlzdCIsImZlYXR1cmUiLCJmaXJzdG5hbWUiLCJsYXN0bmFtZSIsImFwaUtleSIsInByb2Nlc3MiLCJlbnYiLCJNQUlMR1VOX0FQSV9LRVkiLCJkb21haW4iLCJNQUlMR1VOX0RPTUFJTiIsIm1haWxndW4iLCJNYWlsZ3VuIiwibWFpbGxpc3QiLCJsaXN0cyIsInN1YnNjcmliZXIiLCJzdWJzY3JpYmVkIiwiYWRkcmVzcyIsInZhcnMiLCJtZW1iZXJzIiwiY3JlYXRlIiwidGhlbiIsImRhdGEiLCJsb2dnaW5nIiwiZGVidWciLCJtYWlsZXIiLCJzaWdudXBFbWFpbCIsInRvIiwic2VuZFN0YXR1cyIsImNhdGNoIiwiZXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFD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QUFDQSxRQUFNSSxRQUFRLEdBQUdGLE9BQU8sQ0FBQ0csS0FBUixDQUFjLCtCQUFkLENBQWpCO0FBRUEsUUFBTUMsVUFBVSxHQUFHO0FBQ2pCQyxJQUFBQSxVQUFVLEVBQUUsSUFESztBQUVqQkMsSUFBQUEsT0FBTyxFQUFFOUMsS0FGUTtBQUdqQnNCLElBQUFBLElBQUksRUFBRyxHQUFFVSxTQUFVLElBQUdDLFFBQVMsRUFIZDtBQUlqQmMsSUFBQUEsSUFBSSxFQUFFO0FBQ0poQixNQUFBQSxPQURJO0FBRUpELE1BQUFBO0FBRkk7QUFKVyxHQUFuQjtBQVVBWSxFQUFBQSxRQUFRLENBQ0xNLE9BREgsR0FFR0MsTUFGSCxDQUVVTCxVQUZWLEVBR0dNLElBSEgsQ0FHUUMsSUFBSSxJQUFJO0FBQ1pDLHFCQUFRQyxLQUFSLENBQWNGLElBQWQ7O0FBQ0EsV0FBT0csZUFBT0MsV0FBUCxDQUFtQjtBQUFFQyxNQUFBQSxFQUFFLEVBQUV4RCxLQUFOO0FBQWFzQixNQUFBQSxJQUFJLEVBQUVVO0FBQW5CLEtBQW5CLENBQVA7QUFDRCxHQU5ILEVBT0drQixJQVBILENBT1EsTUFBTTdELEdBQUcsQ0FBQ29FLFVBQUosQ0FBZSxHQUFmLENBUGQsRUFRR0MsS0FSSCxDQVFTdEQsR0FBRyxJQUFJO0FBQ1pnRCxxQkFBUU8sS0FBUixDQUFjdkQsR0FBRyxDQUFDRyxPQUFsQjs7QUFDQWxCLElBQUFBLEdBQUcsQ0FBQ2MsSUFBSixDQUFTLEdBQVQsRUFBY0MsR0FBRyxDQUFDRyxPQUFsQjtBQUNELEdBWEg7QUFZRCxDQWhDTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgTWFpbGd1biBmcm9tICdtYWlsZ3VuLWpzJztcbmltcG9ydCB1c2VyTWFuYWdlciBmcm9tICcuLi9oZWxwZXJzL3VzZXJNYW5hZ2VyJztcbmltcG9ydCBsb2dnaW5nIGZyb20gJy4uLy4uL2xvZ2dpbmcnO1xuaW1wb3J0IG1haWxlciBmcm9tICcuLi8uLi9lbWFpbCc7XG5cbmV4cG9ydCBjb25zdCBhdXRoZW50aWNhdGUgPSAocmVxLCByZXMpID0+IHtcbiAgLy8gY2hlY2sgdGhlIGhlYWRlcnNcbiAgaWYgKFxuICAgIHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24gJiZcbiAgICByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnYmFzaWMnKVxuICApIHtcbiAgICByZXR1cm4gdXNlck1hbmFnZXIuYmFzaWNBdXRoZW50aWNhdGlvbihyZXEsIHJlcyk7XG4gIH1cbiAgaWYgKFxuICAgICFyZXEuaGVhZGVycy5hdXRob3JpemF0aW9uICYmXG4gICAgcmVxLmJvZHkuaW5kZXhPZignZ3JhbnRfdHlwZT1yZWZyZXNoX3Rva2VuJykgIT09IC0xXG4gICkge1xuICAgIHJldHVybiB1c2VyTWFuYWdlci50b2tlbkF1dGhlbnRpY2F0aW9uKHJlcSwgcmVzKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHNpZ251cCA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCwgZGlzcGxheU5hbWUgfSA9IHJlcS5ib2R5O1xuICBpZiAoIWVtYWlsIHx8ICFwYXNzd29yZCkge1xuICAgIHJldHVybiByZXMuc2VuZCg0MDAsIHtcbiAgICAgIGVycjogJ0VtYWlsIC8gcGFzc3dvcmQgcmVxdWlyZWQgdG8gY3JlYXRlIGFuIGFjY291bnQnXG4gICAgfSk7XG4gIH1cbiAgdHJ5IHtcbiAgICBjb25zdCB0b2tlbiA9IGF3YWl0IHVzZXJNYW5hZ2VyLnNpZ251cFVzZXIoZW1haWwsIHBhc3N3b3JkLCBkaXNwbGF5TmFtZSk7XG4gICAgcmVzLnNlbmQoMjAwLCB0b2tlbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJlcy5zZW5kKDQwMCwgeyBlcnI6IGVyci5tZXNzYWdlIH0pO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgdmVyaWZ5VXNlciA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB7IGVtYWlsIH0gPSByZXEucXVlcnk7XG4gIGlmIChfLmlzTmlsKGVtYWlsKSkge1xuICAgIHJldHVybiByZXMuc2VuZCg0MDQsICcnKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgaXNWYWxpZCA9IGF3YWl0IHVzZXJNYW5hZ2VyLmlzVXNlcihlbWFpbCk7XG4gICAgaWYgKGlzVmFsaWQpIHtcbiAgICAgIHJldHVybiByZXMuc2VuZCgyMDApO1xuICAgIH1cbiAgICByZXR1cm4gcmVzLnNlbmQoNDA0KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmVzLnNlbmQoNDA0KTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGludml0ZVVzZXJzVG9Xb3Jrc3BhY2UgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgeyBlbWFpbHMsIHdvcmtzcGFjZUlkIH0gPSByZXEuYm9keTtcbiAgY29uc3QgeyBhdXRob3JpemF0aW9uIH0gPSByZXEuaGVhZGVycztcblxuICB0cnkge1xuICAgIGNvbnN0IGNyZWF0b3JVaWQgPSBhd2FpdCB1c2VyTWFuYWdlci5iZWFyZXJUb1VpZChhdXRob3JpemF0aW9uKTtcbiAgICBpZiAoIWNyZWF0b3JVaWQpIHtcbiAgICAgIHJldHVybiByZXMuc2VuZCg0MDEsIHsgbWVzc2FnZTogJ0Nhbm5vdCBpbnZpdGUgdXNlciBhbm9ueW1vdXNseScgfSk7XG4gICAgfVxuICAgIGF3YWl0IHVzZXJNYW5hZ2VyLmludml0ZVVzZXJzKGVtYWlscywgd29ya3NwYWNlSWQsIGNyZWF0b3JVaWQpO1xuICAgIHJlcy5zZW5kKDIwMCwge1xuICAgICAgc3RhdHVzOiAnaW52aXRlZCdcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmVzLnNlbmQoNDAwLCB7IG1lc3NhZ2U6ICdub3QgaW52aXRlZCcgfSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVXb3Jrc3BhY2UgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgeyBuYW1lIH0gPSByZXEuYm9keTtcbiAgY29uc3QgeyBhdXRob3JpemF0aW9uIH0gPSByZXEuaGVhZGVycztcblxuICB0cnkge1xuICAgIGNvbnN0IGNyZWF0b3JVaWQgPSBhd2FpdCB1c2VyTWFuYWdlci5iZWFyZXJUb1VpZChhdXRob3JpemF0aW9uKTtcbiAgICBpZiAoIWNyZWF0b3JVaWQpIHtcbiAgICAgIHJldHVybiByZXMuc2VuZCg0MDEsIHsgbWVzc2FnZTogJ0Nhbm5vdCBjcmVhdGUgd29ya3NwYWNlIGFub255bW91c2x5JyB9KTtcbiAgICB9XG4gICAgY29uc3Qgd29ya3NwYWNlSWQgPSBhd2FpdCB1c2VyTWFuYWdlci5jcmVhdGVXb3Jrc3BhY2UobmFtZSwgY3JlYXRvclVpZCk7XG4gICAgcmVzLnNlbmQoMjAwLCB7XG4gICAgICB3b3Jrc3BhY2VJZFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXMuc2VuZCg0MDAsIHsgbWVzc2FnZTogYFdvcmtzcGFjZSBub3QgY3JlYXRlZDogJHtlcnIubWVzc2FnZX1gIH0pO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0RG9tYWlucyA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCByZWZyZXNoVG9rZW4gPSByZXEucGFyYW1zLnRva2VuLnZhbHVlO1xuICBpZiAoIXJlZnJlc2hUb2tlbikge1xuICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICBkb21haW5zOiBbXVxuICAgIH0pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBkb21haW5zID0gYXdhaXQgdXNlck1hbmFnZXIuZ2V0RG9tYWlucyhyZWZyZXNoVG9rZW4pO1xuICAgIHJlcy5qc29uKHtcbiAgICAgIGRvbWFpbnNcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmVzLmpzb24oe1xuICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2VcbiAgICB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGVtYWlsTGlzdFNpZ251cCA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB7IGxpc3QsIGZlYXR1cmUgfSA9IHJlcS5xdWVyeTtcbiAgY29uc3QgeyBmaXJzdG5hbWUsIGxhc3RuYW1lLCBlbWFpbCB9ID0gcmVxLmJvZHk7XG5cbiAgY29uc3QgYXBpS2V5ID0gcHJvY2Vzcy5lbnYuTUFJTEdVTl9BUElfS0VZO1xuICBjb25zdCBkb21haW4gPSBwcm9jZXNzLmVudi5NQUlMR1VOX0RPTUFJTjtcblxuICBjb25zdCBtYWlsZ3VuID0gbmV3IE1haWxndW4oeyBhcGlLZXksIGRvbWFpbiB9KTtcbiAgY29uc3QgbWFpbGxpc3QgPSBtYWlsZ3VuLmxpc3RzKCdlYXJseS1hY2Nlc3NAbWFpbC5nZXRkaWZmLmFwcCcpO1xuXG4gIGNvbnN0IHN1YnNjcmliZXIgPSB7XG4gICAgc3Vic2NyaWJlZDogdHJ1ZSxcbiAgICBhZGRyZXNzOiBlbWFpbCxcbiAgICBuYW1lOiBgJHtmaXJzdG5hbWV9ICR7bGFzdG5hbWV9YCxcbiAgICB2YXJzOiB7XG4gICAgICBmZWF0dXJlLFxuICAgICAgbGlzdFxuICAgIH1cbiAgfTtcblxuICBtYWlsbGlzdFxuICAgIC5tZW1iZXJzKClcbiAgICAuY3JlYXRlKHN1YnNjcmliZXIpXG4gICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICBsb2dnaW5nLmRlYnVnKGRhdGEpO1xuICAgICAgcmV0dXJuIG1haWxlci5zaWdudXBFbWFpbCh7IHRvOiBlbWFpbCwgbmFtZTogZmlyc3RuYW1lIH0pO1xuICAgIH0pXG4gICAgLnRoZW4oKCkgPT4gcmVzLnNlbmRTdGF0dXMoMjAxKSlcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIGxvZ2dpbmcuZXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgICAgcmVzLnNlbmQoNDAwLCBlcnIubWVzc2FnZSk7XG4gICAgfSk7XG59O1xuIl19