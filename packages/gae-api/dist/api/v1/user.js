"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.emailListSignup = exports.getDomains = exports.createWorkspace = exports.inviteUsersToWorkspace = exports.verifyUser = exports.signup = exports.authenticate = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _mailgunJs = _interopRequireDefault(require("mailgun-js"));

var userManager = _interopRequireWildcard(require("../../firestore/users"));

var _logging = _interopRequireDefault(require("../../logging"));

var _email = _interopRequireDefault(require("../../email"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const authenticate = (req, res) => {
  // check the headers
  if (req.headers.authorization && req.headers.authorization.toLowerCase().startsWith('basic')) {
    return userManager.basicAuthentication(req, res);
  }

  if (!req.headers.authorization && req.body.indexOf('grant_type=refresh_token') !== -1) {
    return userManager.tokenAuthentication(req, res);
  }
};

exports.authenticate = authenticate;

const signup = async (req, res) => {
  const {
    email,
    password,
    displayName
  } = req.body;

  if (!email || !password) {
    return res.send(400, {
      err: 'Email / password required to create an account'
    });
  }

  try {
    const token = await userManager.signupUser(email, password, displayName);
    res.send(200, token);
  } catch (err) {
    res.send(400, {
      err: err.message
    });
  }
};

exports.signup = signup;

const verifyUser = async (req, res) => {
  const {
    email
  } = req.query;

  if (_lodash.default.isNil(email)) {
    return res.send(404, '');
  }

  try {
    const isValid = await userManager.isUser(email);

    if (isValid) {
      return res.send(200);
    }

    return res.send(404);
  } catch (err) {
    res.send(404);
  }
};

exports.verifyUser = verifyUser;

const inviteUsersToWorkspace = async (req, res) => {
  if (!req.user) {
    res.send(401, 'User not specified');
  }

  const {
    emails,
    workspaceId
  } = req.body;
  const {
    authorization
  } = req.headers;

  try {
    const creatorUid = await userManager.bearerToUid(authorization);

    if (!creatorUid) {
      return res.send(401, {
        message: 'Cannot invite user anonymously'
      });
    }

    await userManager.inviteUsers(emails, workspaceId, creatorUid);
    res.send(200, {
      status: 'invited'
    });
  } catch (err) {
    res.send(400, {
      message: 'not invited'
    });
  }
};

exports.inviteUsersToWorkspace = inviteUsersToWorkspace;

const createWorkspace = async (req, res) => {
  const {
    name
  } = req.body;
  const {
    authorization
  } = req.headers;

  try {
    const creatorUid = await userManager.bearerToUid(authorization);

    if (!creatorUid) {
      return res.send(401, {
        message: 'Cannot create workspace anonymously'
      });
    }

    const workspaceId = await userManager.createWorkspace(name, creatorUid);
    res.send(200, {
      workspaceId
    });
  } catch (err) {
    res.send(400, {
      message: `Workspace not created: ${err.message}`
    });
  }
};

exports.createWorkspace = createWorkspace;

const getDomains = async (req, res) => {
  const refreshToken = req.params.token.value;

  if (!refreshToken) {
    return res.json({
      domains: []
    });
  }

  try {
    const domains = await userManager.getDomains(refreshToken);
    res.json({
      domains
    });
  } catch (err) {
    res.json({
      message: err.message
    });
  }
};

exports.getDomains = getDomains;

const emailListSignup = async (req, res) => {
  const {
    list,
    feature
  } = req.query;
  const {
    firstname,
    lastname,
    email
  } = req.body;
  const apiKey = process.env.MAILGUN_API_KEY;
  const domain = process.env.MAILGUN_DOMAIN;
  const mailgun = new _mailgunJs.default({
    apiKey,
    domain
  });
  const maillist = mailgun.lists('early-access@mail.getdiff.app');
  const subscriber = {
    subscribed: true,
    address: email,
    name: `${firstname} ${lastname}`,
    vars: {
      feature,
      list
    }
  };
  maillist.members().create(subscriber).then(data => {
    _logging.default.debug(data);

    return _email.default.signupEmail({
      to: email,
      name: firstname
    });
  }).then(() => res.sendStatus(201)).catch(err => {
    _logging.default.error(err.message);

    res.send(400, err.message);
  });
};

exports.emailListSignup = emailListSignup;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvdjEvdXNlci5qcyJdLCJuYW1lcyI6WyJhdXRoZW50aWNhdGUiLCJyZXEiLCJyZXMiLCJoZWFkZXJzIiwiYXV0aG9yaXphdGlvbiIsInRvTG93ZXJDYXNlIiwic3RhcnRzV2l0aCIsInVzZXJNYW5hZ2VyIiwiYmFzaWNBdXRoZW50aWNhdGlvbiIsImJvZHkiLCJpbmRleE9mIiwidG9rZW5BdXRoZW50aWNhdGlvbiIsInNpZ251cCIsImVtYWlsIiwicGFzc3dvcmQiLCJkaXNwbGF5TmFtZSIsInNlbmQiLCJlcnIiLCJ0b2tlbiIsInNpZ251cFVzZXIiLCJtZXNzYWdlIiwidmVyaWZ5VXNlciIsInF1ZXJ5IiwiXyIsImlzTmlsIiwiaXNWYWxpZCIsImlzVXNlciIsImludml0ZVVzZXJzVG9Xb3Jrc3BhY2UiLCJ1c2VyIiwiZW1haWxzIiwid29ya3NwYWNlSWQiLCJjcmVhdG9yVWlkIiwiYmVhcmVyVG9VaWQiLCJpbnZpdGVVc2VycyIsInN0YXR1cyIsImNyZWF0ZVdvcmtzcGFjZSIsIm5hbWUiLCJnZXREb21haW5zIiwicmVmcmVzaFRva2VuIiwicGFyYW1zIiwidmFsdWUiLCJqc29uIiwiZG9tYWlucyIsImVtYWlsTGlzdFNpZ251cCIsImxpc3QiLCJmZWF0dXJlIiwiZmlyc3RuYW1lIiwibGFzdG5hbWUiLCJhcGlLZXkiLCJwcm9jZXNzIiwiZW52IiwiTUFJTEdVTl9BUElfS0VZIiwiZG9tYWluIiwiTUFJTEdVTl9ET01BSU4iLCJtYWlsZ3VuIiwiTWFpbGd1biIsIm1haWxsaXN0IiwibGlzdHMiLCJzdWJzY3JpYmVyIiwic3Vic2NyaWJlZCIsImFkZHJlc3MiLCJ2YXJzIiwibWVtYmVycyIsImNyZWF0ZSIsInRoZW4iLCJkYXRhIiwibG9nZ2luZyIsImRlYnVnIiwibWFpbGVyIiwic2lnbnVwRW1haWwiLCJ0byIsInNlbmRTdGF0dXMiLCJjYXRjaCIsImVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FB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QUEzQjtBQUNBLFFBQU1DLE1BQU0sR0FBR0gsT0FBTyxDQUFDQyxHQUFSLENBQVlHLGNBQTNCO0FBRUEsUUFBTUMsT0FBTyxHQUFHLElBQUlDLGtCQUFKLENBQVk7QUFBRVAsSUFBQUEsTUFBRjtBQUFVSSxJQUFBQTtBQUFWLEdBQVosQ0FBaEI7QUFDQSxRQUFNSSxRQUFRLEdBQUdGLE9BQU8sQ0FBQ0csS0FBUixDQUFjLCtCQUFkLENBQWpCO0FBRUEsUUFBTUMsVUFBVSxHQUFHO0FBQ2pCQyxJQUFBQSxVQUFVLEVBQUUsSUFESztBQUVqQkMsSUFBQUEsT0FBTyxFQUFFL0MsS0FGUTtBQUdqQnVCLElBQUFBLElBQUksRUFBRyxHQUFFVSxTQUFVLElBQUdDLFFBQVMsRUFIZDtBQUlqQmMsSUFBQUEsSUFBSSxFQUFFO0FBQ0poQixNQUFBQSxPQURJO0FBRUpELE1BQUFBO0FBRkk7QUFKVyxHQUFuQjtBQVVBWSxFQUFBQSxRQUFRLENBQ0xNLE9BREgsR0FFR0MsTUFGSCxDQUVVTCxVQUZWLEVBR0dNLElBSEgsQ0FHUUMsSUFBSSxJQUFJO0FBQ1pDLHFCQUFRQyxLQUFSLENBQWNGLElBQWQ7O0FBQ0EsV0FBT0csZUFBT0MsV0FBUCxDQUFtQjtBQUFFQyxNQUFBQSxFQUFFLEVBQUV6RCxLQUFOO0FBQWF1QixNQUFBQSxJQUFJLEVBQUVVO0FBQW5CLEtBQW5CLENBQVA7QUFDRCxHQU5ILEVBT0drQixJQVBILENBT1EsTUFBTTlELEdBQUcsQ0FBQ3FFLFVBQUosQ0FBZSxHQUFmLENBUGQsRUFRR0MsS0FSSCxDQVFTdkQsR0FBRyxJQUFJO0FBQ1ppRCxxQkFBUU8sS0FBUixDQUFjeEQsR0FBRyxDQUFDRyxPQUFsQjs7QUFDQWxCLElBQUFBLEdBQUcsQ0FBQ2MsSUFBSixDQUFTLEdBQVQsRUFBY0MsR0FBRyxDQUFDRyxPQUFsQjtBQUNELEdBWEg7QUFZRCxDQWhDTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgTWFpbGd1biBmcm9tICdtYWlsZ3VuLWpzJztcbmltcG9ydCAqIGFzIHVzZXJNYW5hZ2VyIGZyb20gJy4uLy4uL2ZpcmVzdG9yZS91c2Vycyc7XG5pbXBvcnQgbG9nZ2luZyBmcm9tICcuLi8uLi9sb2dnaW5nJztcbmltcG9ydCBtYWlsZXIgZnJvbSAnLi4vLi4vZW1haWwnO1xuXG5leHBvcnQgY29uc3QgYXV0aGVudGljYXRlID0gKHJlcSwgcmVzKSA9PiB7XG4gIC8vIGNoZWNrIHRoZSBoZWFkZXJzXG4gIGlmIChcbiAgICByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uICYmXG4gICAgcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbi50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoJ2Jhc2ljJylcbiAgKSB7XG4gICAgcmV0dXJuIHVzZXJNYW5hZ2VyLmJhc2ljQXV0aGVudGljYXRpb24ocmVxLCByZXMpO1xuICB9XG4gIGlmIChcbiAgICAhcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbiAmJlxuICAgIHJlcS5ib2R5LmluZGV4T2YoJ2dyYW50X3R5cGU9cmVmcmVzaF90b2tlbicpICE9PSAtMVxuICApIHtcbiAgICByZXR1cm4gdXNlck1hbmFnZXIudG9rZW5BdXRoZW50aWNhdGlvbihyZXEsIHJlcyk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBzaWdudXAgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQsIGRpc3BsYXlOYW1lIH0gPSByZXEuYm9keTtcbiAgaWYgKCFlbWFpbCB8fCAhcGFzc3dvcmQpIHtcbiAgICByZXR1cm4gcmVzLnNlbmQoNDAwLCB7XG4gICAgICBlcnI6ICdFbWFpbCAvIHBhc3N3b3JkIHJlcXVpcmVkIHRvIGNyZWF0ZSBhbiBhY2NvdW50J1xuICAgIH0pO1xuICB9XG4gIHRyeSB7XG4gICAgY29uc3QgdG9rZW4gPSBhd2FpdCB1c2VyTWFuYWdlci5zaWdudXBVc2VyKGVtYWlsLCBwYXNzd29yZCwgZGlzcGxheU5hbWUpO1xuICAgIHJlcy5zZW5kKDIwMCwgdG9rZW4pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXMuc2VuZCg0MDAsIHsgZXJyOiBlcnIubWVzc2FnZSB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHZlcmlmeVVzZXIgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgeyBlbWFpbCB9ID0gcmVxLnF1ZXJ5O1xuICBpZiAoXy5pc05pbChlbWFpbCkpIHtcbiAgICByZXR1cm4gcmVzLnNlbmQoNDA0LCAnJyk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCB1c2VyTWFuYWdlci5pc1VzZXIoZW1haWwpO1xuICAgIGlmIChpc1ZhbGlkKSB7XG4gICAgICByZXR1cm4gcmVzLnNlbmQoMjAwKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlcy5zZW5kKDQwNCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJlcy5zZW5kKDQwNCk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBpbnZpdGVVc2Vyc1RvV29ya3NwYWNlID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGlmICghcmVxLnVzZXIpIHtcbiAgICByZXMuc2VuZCg0MDEsICdVc2VyIG5vdCBzcGVjaWZpZWQnKTtcbiAgfVxuXG4gIGNvbnN0IHsgZW1haWxzLCB3b3Jrc3BhY2VJZCB9ID0gcmVxLmJvZHk7XG4gIGNvbnN0IHsgYXV0aG9yaXphdGlvbiB9ID0gcmVxLmhlYWRlcnM7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBjcmVhdG9yVWlkID0gYXdhaXQgdXNlck1hbmFnZXIuYmVhcmVyVG9VaWQoYXV0aG9yaXphdGlvbik7XG4gICAgaWYgKCFjcmVhdG9yVWlkKSB7XG4gICAgICByZXR1cm4gcmVzLnNlbmQoNDAxLCB7IG1lc3NhZ2U6ICdDYW5ub3QgaW52aXRlIHVzZXIgYW5vbnltb3VzbHknIH0pO1xuICAgIH1cbiAgICBhd2FpdCB1c2VyTWFuYWdlci5pbnZpdGVVc2VycyhlbWFpbHMsIHdvcmtzcGFjZUlkLCBjcmVhdG9yVWlkKTtcbiAgICByZXMuc2VuZCgyMDAsIHtcbiAgICAgIHN0YXR1czogJ2ludml0ZWQnXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJlcy5zZW5kKDQwMCwgeyBtZXNzYWdlOiAnbm90IGludml0ZWQnIH0pO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlV29ya3NwYWNlID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHsgbmFtZSB9ID0gcmVxLmJvZHk7XG4gIGNvbnN0IHsgYXV0aG9yaXphdGlvbiB9ID0gcmVxLmhlYWRlcnM7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBjcmVhdG9yVWlkID0gYXdhaXQgdXNlck1hbmFnZXIuYmVhcmVyVG9VaWQoYXV0aG9yaXphdGlvbik7XG4gICAgaWYgKCFjcmVhdG9yVWlkKSB7XG4gICAgICByZXR1cm4gcmVzLnNlbmQoNDAxLCB7IG1lc3NhZ2U6ICdDYW5ub3QgY3JlYXRlIHdvcmtzcGFjZSBhbm9ueW1vdXNseScgfSk7XG4gICAgfVxuICAgIGNvbnN0IHdvcmtzcGFjZUlkID0gYXdhaXQgdXNlck1hbmFnZXIuY3JlYXRlV29ya3NwYWNlKG5hbWUsIGNyZWF0b3JVaWQpO1xuICAgIHJlcy5zZW5kKDIwMCwge1xuICAgICAgd29ya3NwYWNlSWRcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmVzLnNlbmQoNDAwLCB7IG1lc3NhZ2U6IGBXb3Jrc3BhY2Ugbm90IGNyZWF0ZWQ6ICR7ZXJyLm1lc3NhZ2V9YCB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGdldERvbWFpbnMgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgcmVmcmVzaFRva2VuID0gcmVxLnBhcmFtcy50b2tlbi52YWx1ZTtcbiAgaWYgKCFyZWZyZXNoVG9rZW4pIHtcbiAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgZG9tYWluczogW11cbiAgICB9KTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgZG9tYWlucyA9IGF3YWl0IHVzZXJNYW5hZ2VyLmdldERvbWFpbnMocmVmcmVzaFRva2VuKTtcbiAgICByZXMuanNvbih7XG4gICAgICBkb21haW5zXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJlcy5qc29uKHtcbiAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlXG4gICAgfSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBlbWFpbExpc3RTaWdudXAgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgeyBsaXN0LCBmZWF0dXJlIH0gPSByZXEucXVlcnk7XG4gIGNvbnN0IHsgZmlyc3RuYW1lLCBsYXN0bmFtZSwgZW1haWwgfSA9IHJlcS5ib2R5O1xuXG4gIGNvbnN0IGFwaUtleSA9IHByb2Nlc3MuZW52Lk1BSUxHVU5fQVBJX0tFWTtcbiAgY29uc3QgZG9tYWluID0gcHJvY2Vzcy5lbnYuTUFJTEdVTl9ET01BSU47XG5cbiAgY29uc3QgbWFpbGd1biA9IG5ldyBNYWlsZ3VuKHsgYXBpS2V5LCBkb21haW4gfSk7XG4gIGNvbnN0IG1haWxsaXN0ID0gbWFpbGd1bi5saXN0cygnZWFybHktYWNjZXNzQG1haWwuZ2V0ZGlmZi5hcHAnKTtcblxuICBjb25zdCBzdWJzY3JpYmVyID0ge1xuICAgIHN1YnNjcmliZWQ6IHRydWUsXG4gICAgYWRkcmVzczogZW1haWwsXG4gICAgbmFtZTogYCR7Zmlyc3RuYW1lfSAke2xhc3RuYW1lfWAsXG4gICAgdmFyczoge1xuICAgICAgZmVhdHVyZSxcbiAgICAgIGxpc3RcbiAgICB9XG4gIH07XG5cbiAgbWFpbGxpc3RcbiAgICAubWVtYmVycygpXG4gICAgLmNyZWF0ZShzdWJzY3JpYmVyKVxuICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgbG9nZ2luZy5kZWJ1ZyhkYXRhKTtcbiAgICAgIHJldHVybiBtYWlsZXIuc2lnbnVwRW1haWwoeyB0bzogZW1haWwsIG5hbWU6IGZpcnN0bmFtZSB9KTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IHJlcy5zZW5kU3RhdHVzKDIwMSkpXG4gICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICBsb2dnaW5nLmVycm9yKGVyci5tZXNzYWdlKTtcbiAgICAgIHJlcy5zZW5kKDQwMCwgZXJyLm1lc3NhZ2UpO1xuICAgIH0pO1xufTtcbiJdfQ==