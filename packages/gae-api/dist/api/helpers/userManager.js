"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _crypto = _interopRequireDefault(require("crypto"));

var _querystring = _interopRequireDefault(require("querystring"));

var _lodash = _interopRequireDefault(require("lodash"));

var emailNotify = _interopRequireWildcard(require("./email"));

var _workspace = _interopRequireDefault(require("./workspace"));

var _firestore = require("../../firestore");

var _logging = _interopRequireDefault(require("../../logging"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const retrieveClaimsForUid = async uid => {
  const claims = {};
  return claims;
};

const createAndStoreRefreshToken = async uid => {
  const token = `${_crypto.default.randomBytes(15).toString('hex')}`;
  await _firestore.db.collection('refreshToken').doc(uid).set({
    uid,
    token,
    created: _firestore.admin.firestore.FieldValue.serverTimestamp()
  });
  return token;
};

const createTokenForUid = async (uid, offlineScope = false) => {
  const claims = await retrieveClaimsForUid(uid);
  const access_token = await _firestore.admin.auth().createCustomToken(uid, claims);
  const customToken = {
    access_token
  };

  if (offlineScope) {
    const refresh_token = await createAndStoreRefreshToken(uid);
    Object.assign(customToken, {
      refresh_token
    });
  }

  return customToken;
};

const restoreTokenForUid = async (uid, refresh_token) => {
  const customToken = await createTokenForUid(uid);
  return Object.assign({}, customToken, {
    refresh_token
  });
};
/**
 * Creates a basic user record`
 * @param {String} user
 * @returns {Promise}
 */


const initializeUser = user => _firestore.db.collection('users').doc(user.uid).set({
  displayName: user.displayName,
  photoUrl: null,
  uid: user.uid,
  email: user.email,
  verified: false
});

const basicAuthentication = (req, res) => {
  const token = req.headers.authorization.split(' ')[1];

  _logging.default.info('Basic Token', token);

  const buf = Buffer.from(token, 'base64');
  const [username, password] = buf.toString().split(':');
  const offlineScope = true;

  _logging.default.info('Attempting to perform basic authentication', username);

  _firestore.admin.auth().signInWithEmailAndPassword(username, password).then(credential => {
    _logging.default.info('User signed in', username);

    const {
      user
    } = credential;
    return createTokenForUid(user.uid, offlineScope);
  }).then(customToken => {
    res.send(200, customToken);
  }).catch(error => {
    res.send(401, {
      err: error.message
    });
  });
};

const tokenAuthentication = async (req, res) => {
  try {
    // As an admin, the app has access to read and write all data, regardless of Security Rules
    const token = _querystring.default.parse(req.body).refresh_token;

    const snapshot = await _firestore.db.collection('refreshToken').where('token', '==', token).limit(1).get();

    if (snapshot.docs.length > 0) {
      const {
        uid
      } = snapshot.docs[0].data();
      const customToken = await restoreTokenForUid(uid, token);
      return res.send(200, customToken);
    }

    return res.send(401, {
      err: 'Invalid refresh token'
    });
  } catch (error) {
    return res.send(401, {
      err: error.message
    });
  }
};

const autoAcceptWorkspaceInvites = async (email, uid) => {
  const querySnapshot = await _firestore.db.collection('invites').where('email', '==', email).where('status', '==', 'pending').get(); // we have pending invites

  if (!querySnapshot.empty) {
    querySnapshot.forEach(async inviteDoc => {
      // 1. get our invite
      const invite = inviteDoc.data();
      const workspaceId = invite.workspaceId; // 2. get our workspace

      const workspaceDoc = await _firestore.db.collection('workspace').doc(workspaceId).get();
      const workspace = workspaceDoc.data(); // 3. add our user to the workspace

      workspace.users[uid] = true;
      workspaceDoc.ref.update(workspace); // 4. Change our invite status

      invite.status = 'accept.review';
      inviteDoc.ref.update(invite); // 5. send an email

      emailNotify.autoAcceptWorkspaceInvites(invite.email, workspace.name);
    });
  }

  return uid;
};

const signupUser = (email, password, displayName) => {
  const offlineScope = true;
  return _firestore.admin.auth().createUser({
    email,
    password,
    displayName
  }).then(credential => initializeUser(credential).then(() => credential.uid)).then(uid => autoAcceptWorkspaceInvites(email, uid)).then(uid => createTokenForUid(uid, offlineScope));
};

const isUser = async email => {
  const querySnapshot = await _firestore.db.collection('users').where('email', '==', email).limit(1).get();
  return !querySnapshot.empty;
};

const bearerToUid = async authorizationBearer => {
  if (!_lodash.default.isNil(authorizationBearer) && authorizationBearer.toLowerCase().startsWith('bearer')) {
    const idToken = authorizationBearer.split(' ')[1];
    return _firestore.admin.auth().verifyIdToken(idToken).then(decodedToken => decodedToken.uid);
  }

  return null;
};

const inviteUsers = async (emails, workspaceId, creatorUid) => {
  const workspaceDoc = await _firestore.db.collection('workspace').doc(workspaceId).get();

  if (!workspaceDoc.exists) {
    throw new Error('workspace does not exist');
  }

  const workspaceRecord = workspaceDoc.data();
  return Promise.all(emails.map(async email => {
    // check if we already have an invite for this user and workspace id
    const inviteEmailToWorkspaceRef = await _firestore.db.collection('invites').where('email', '==', email).where('workspaceId', '==', workspaceId).get();

    if (!inviteEmailToWorkspaceRef.empty) {
      _logging.default.info(`[Already invited to workspace] ${creatorUid} - Attempted to invite user [${email}] to ${workspaceId}`);

      return;
    } // check if we have a user for this email


    const userQuerySnapshot = await _firestore.db.collection('users').where('email', '==', email).limit(1).get();
    const userExists = !userQuerySnapshot.empty; // create a new invite for this user

    const invite = {
      email,
      workspaceId,
      created: _firestore.admin.firestore.FieldValue.serverTimestamp(),
      status: userExists ? 'accept.review' : 'pending',
      invitedBy: creatorUid
    };
    await _firestore.db.collection('invites').doc().set(invite);

    if (userExists) {
      userQuerySnapshot.forEach(async userDoc => {
        const user = await userDoc.data(); // this is a secondary check that should be more rare, however
        // if we no longer have an invite record, at minimum check the workspace to
        // see if the user is part of it

        if (_lodash.default.has(workspaceRecord.users, user.uid)) {
          _logging.default.info(`[Already in workspace] ${creatorUid} - Attempted to invite user [${email}] to ${workspaceId}`);

          return;
        }

        workspaceRecord.users[user.uid] = {
          role: 'collaborator',
          created: _firestore.admin.firestore.FieldValue.serverTimestamp()
        };
        await workspaceDoc.ref.update(workspaceRecord); // upgrade all of the events

        await _workspace.default.updateEventsForWorkspaceId(workspaceDoc.id, userDoc.id); // 2. add the workspace to the user account

        await updateUserWorkspace(userDoc.id, workspaceDoc.id); // add to workspace if its an existing user and notify them that they've been added

        _logging.default.info(`[Existing user invited] ${creatorUid} - Added [${email}] to ${workspaceId}`);

        return emailNotify.autoAcceptWorkspaceInvites(email, workspaceRecord.name);
      });
    } else {
      // this is a brand new user, send the appropriate email
      _logging.default.info(`[New user invited] ${creatorUid} - Added [${email}] to ${workspaceId}`);

      return emailNotify.inviteNewUserToWorkspace(email, workspaceRecord.name);
    }
  }));
};

const updateUserWorkspace = async (uid, workspaceId) => {
  if (_lodash.default.isNil(uid) || _lodash.default.isNil(workspaceId)) {
    throw new Error('uid or workspaceid cannot be null');
  }

  const doc = await _firestore.db.collection('users').doc(uid).get();
  const userRecord = doc.data();
  userRecord.workspaces = Object.assign({}, userRecord.workspaces, {
    [workspaceId]: true
  });
  return doc.ref.update(userRecord);
};

const createWorkspace = async (name, userId) => {
  const userDoc = await _firestore.db.collection('users').doc(userId).get();

  if (!userDoc.exists) {
    return Promise.reject(new Error(`User ${userId} does not exist`));
  }

  const user = userDoc.data();

  _logging.default.info(`Creating a new workspace ${name}`); // 1. create the workspace


  const workspaceDocRef = _firestore.db.collection('workspace').doc();

  const workspace = {
    users: {
      [userId]: {
        role: 'creator',
        created: _firestore.admin.firestore.FieldValue.serverTimestamp()
      }
    },
    name
  };
  await workspaceDocRef.set(workspace); // 2. add the workspace to the user account

  await updateUserWorkspace(userId, workspaceDocRef.id); // 2. Upgrade the user

  const upgradedEvents = await _workspace.default.updateEventsForWorkspaceId(workspaceDocRef.id, userId);

  _logging.default.info(`Updated ${upgradedEvents} for ${userId} and workspace ${name}`); // 3. send email that we have created a new workspace


  await emailNotify.createWorkspace(user.email, name);
  return workspaceDocRef.id;
};

const getDomains = async refreshToken => {
  const snapshot = await _firestore.db.collection('refreshToken').where('token', '==', refreshToken).get();
  const {
    uid
  } = snapshot.docs[0].data();
  const workspaceSnapshot = await _firestore.db.collection('workspace').where(`users.${uid}.role`, '>', '').get();
  const ids = [{
    type: 'uid',
    val: uid
  }];
  workspaceSnapshot.forEach(doc => ids.push({
    type: 'workspace',
    val: doc.id
  }));

  const eventsRef = _firestore.db.collection('events');

  const sitesQueries = await Promise.all(_lodash.default.chain(ids).map(({
    type,
    val
  }) => eventsRef.where(type === 'uid' ? `meta.userId` : 'meta.workspaceId', '==', val).get()).value());

  const sites = _lodash.default.chain(sitesQueries).flatMap(querySnapshot => {
    const docs = [];
    querySnapshot.forEach(doc => docs.push(doc));
    return docs;
  }).map(doc => {
    const data = doc.data();
    return data.url.hostname;
  }).uniq().value();

  return sites;
};

var _default = {
  retrieveClaimsForUid,
  createAndStoreRefreshToken,
  createTokenForUid,
  restoreTokenForUid,
  basicAuthentication,
  tokenAuthentication,
  initializeUser,
  signupUser,
  isUser,
  bearerToUid,
  inviteUsers,
  createWorkspace,
  getDomains
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvaGVscGVycy91c2VyTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJyZXRyaWV2ZUNsYWltc0ZvclVpZCIsInVpZCIsImNsYWltcyIsImNyZWF0ZUFuZFN0b3JlUmVmcmVzaFRva2VuIiwidG9rZW4iLCJjcnlwdG8iLCJyYW5kb21CeXRlcyIsInRvU3RyaW5nIiwiZGIiLCJjb2xsZWN0aW9uIiwiZG9jIiwic2V0IiwiY3JlYXRlZCIsImFkbWluIiwiZmlyZXN0b3JlIiwiRmllbGRWYWx1ZSIsInNlcnZlclRpbWVzdGFtcCIsImNyZWF0ZVRva2VuRm9yVWlkIiwib2ZmbGluZVNjb3BlIiwiYWNjZXNzX3Rva2VuIiwiYXV0aCIsImNyZWF0ZUN1c3RvbVRva2VuIiwiY3VzdG9tVG9rZW4iLCJyZWZyZXNoX3Rva2VuIiwiT2JqZWN0IiwiYXNzaWduIiwicmVzdG9yZVRva2VuRm9yVWlkIiwiaW5pdGlhbGl6ZVVzZXIiLCJ1c2VyIiwiZGlzcGxheU5hbWUiLCJwaG90b1VybCIsImVtYWlsIiwidmVyaWZpZWQiLCJiYXNpY0F1dGhlbnRpY2F0aW9uIiwicmVxIiwicmVzIiwiaGVhZGVycyIsImF1dGhvcml6YXRpb24iLCJzcGxpdCIsImxvZ2dpbmciLCJpbmZvIiwiYnVmIiwiQnVmZmVyIiwiZnJvbSIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJzaWduSW5XaXRoRW1haWxBbmRQYXNzd29yZCIsInRoZW4iLCJjcmVkZW50aWFsIiwic2VuZCIsImNhdGNoIiwiZXJyb3IiLCJlcnIiLCJtZXNzYWdlIiwidG9rZW5BdXRoZW50aWNhdGlvbiIsInF1ZXJ5c3RyaW5nIiwicGFyc2UiLCJib2R5Iiwic25hcHNob3QiLCJ3aGVyZSIsImxpbWl0IiwiZ2V0IiwiZG9jcyIsImxlbmd0aCIsImRhdGEiLCJhdXRvQWNjZXB0V29ya3NwYWNlSW52aXRlcyIsInF1ZXJ5U25hcHNob3QiLCJlbXB0eSIsImZvckVhY2giLCJpbnZpdGVEb2MiLCJpbnZpdGUiLCJ3b3Jrc3BhY2VJZCIsIndvcmtzcGFjZURvYyIsIndvcmtzcGFjZSIsInVzZXJzIiwicmVmIiwidXBkYXRlIiwic3RhdHVzIiwiZW1haWxOb3RpZnkiLCJuYW1lIiwic2lnbnVwVXNlciIsImNyZWF0ZVVzZXIiLCJpc1VzZXIiLCJiZWFyZXJUb1VpZCIsImF1dGhvcml6YXRpb25CZWFyZXIiLCJfIiwiaXNOaWwiLCJ0b0xvd2VyQ2FzZSIsInN0YXJ0c1dpdGgiLCJpZFRva2VuIiwidmVyaWZ5SWRUb2tlbiIsImRlY29kZWRUb2tlbiIsImludml0ZVVzZXJzIiwiZW1haWxzIiwiY3JlYXRvclVpZCIsImV4aXN0cyIsIkVycm9yIiwid29ya3NwYWNlUmVjb3JkIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsImludml0ZUVtYWlsVG9Xb3Jrc3BhY2VSZWYiLCJ1c2VyUXVlcnlTbmFwc2hvdCIsInVzZXJFeGlzdHMiLCJpbnZpdGVkQnkiLCJ1c2VyRG9jIiwiaGFzIiwicm9sZSIsIndvcmtzcGFjZUhlbHBlciIsInVwZGF0ZUV2ZW50c0ZvcldvcmtzcGFjZUlkIiwiaWQiLCJ1cGRhdGVVc2VyV29ya3NwYWNlIiwiaW52aXRlTmV3VXNlclRvV29ya3NwYWNlIiwidXNlclJlY29yZCIsIndvcmtzcGFjZXMiLCJjcmVhdGVXb3Jrc3BhY2UiLCJ1c2VySWQiLCJyZWplY3QiLCJ3b3Jrc3BhY2VEb2NSZWYiLCJ1cGdyYWRlZEV2ZW50cyIsImdldERvbWFpbnMiLCJyZWZyZXNoVG9rZW4iLCJ3b3Jrc3BhY2VTbmFwc2hvdCIsImlkcyIsInR5cGUiLCJ2YWwiLCJwdXNoIiwiZXZlbnRzUmVmIiwic2l0ZXNRdWVyaWVzIiwiY2hhaW4iLCJ2YWx1ZSIsInNpdGVzIiwiZmxhdE1hcCIsInVybCIsImhvc3RuYW1lIiwidW5pcSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxvQkFBb0IsR0FBRyxNQUFNQyxHQUFOLElBQWE7QUFDeEMs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TCxDQUFVcEgsR0FBVixDQUE3QjtBQUNBLFdBQU9vRCxJQUFQO0FBQ0QsR0FMVyxFQU1Yc0MsR0FOVyxDQU1QMUYsR0FBRyxJQUFJO0FBQ1YsVUFBTXNELElBQUksR0FBR3RELEdBQUcsQ0FBQ3NELElBQUosRUFBYjtBQUNBLFdBQU9BLElBQUksQ0FBQ3FFLEdBQUwsQ0FBU0MsUUFBaEI7QUFDRCxHQVRXLEVBVVhDLElBVlcsR0FXWEwsS0FYVyxFQUFkOztBQWFBLFNBQU9DLEtBQVA7QUFDRCxDQTNDRDs7ZUE2Q2U7QUFDYm5JLEVBQUFBLG9CQURhO0FBRWJHLEVBQUFBLDBCQUZhO0FBR2JjLEVBQUFBLGlCQUhhO0FBSWJTLEVBQUFBLGtCQUphO0FBS2JPLEVBQUFBLG1CQUxhO0FBTWJxQixFQUFBQSxtQkFOYTtBQU9iM0IsRUFBQUEsY0FQYTtBQVFicUQsRUFBQUEsVUFSYTtBQVNiRSxFQUFBQSxNQVRhO0FBVWJDLEVBQUFBLFdBVmE7QUFXYlMsRUFBQUEsV0FYYTtBQVlidUIsRUFBQUEsZUFaYTtBQWFiSyxFQUFBQTtBQWJhLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgcXVlcnlzdHJpbmcgZnJvbSAncXVlcnlzdHJpbmcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGVtYWlsTm90aWZ5IGZyb20gJy4vZW1haWwnO1xuaW1wb3J0IHdvcmtzcGFjZUhlbHBlciBmcm9tICcuL3dvcmtzcGFjZSc7XG5pbXBvcnQgeyBhZG1pbiwgZGIgfSBmcm9tICcuLi8uLi9maXJlc3RvcmUnO1xuaW1wb3J0IGxvZ2dpbmcgZnJvbSAnLi4vLi4vbG9nZ2luZyc7XG5cbmNvbnN0IHJldHJpZXZlQ2xhaW1zRm9yVWlkID0gYXN5bmMgdWlkID0+IHtcbiAgY29uc3QgY2xhaW1zID0ge307XG5cbiAgcmV0dXJuIGNsYWltcztcbn07XG5cbmNvbnN0IGNyZWF0ZUFuZFN0b3JlUmVmcmVzaFRva2VuID0gYXN5bmMgdWlkID0+IHtcbiAgY29uc3QgdG9rZW4gPSBgJHtjcnlwdG8ucmFuZG9tQnl0ZXMoMTUpLnRvU3RyaW5nKCdoZXgnKX1gO1xuICBhd2FpdCBkYlxuICAgIC5jb2xsZWN0aW9uKCdyZWZyZXNoVG9rZW4nKVxuICAgIC5kb2ModWlkKVxuICAgIC5zZXQoe1xuICAgICAgdWlkLFxuICAgICAgdG9rZW4sXG4gICAgICBjcmVhdGVkOiBhZG1pbi5maXJlc3RvcmUuRmllbGRWYWx1ZS5zZXJ2ZXJUaW1lc3RhbXAoKVxuICAgIH0pO1xuXG4gIHJldHVybiB0b2tlbjtcbn07XG5cbmNvbnN0IGNyZWF0ZVRva2VuRm9yVWlkID0gYXN5bmMgKHVpZCwgb2ZmbGluZVNjb3BlID0gZmFsc2UpID0+IHtcbiAgY29uc3QgY2xhaW1zID0gYXdhaXQgcmV0cmlldmVDbGFpbXNGb3JVaWQodWlkKTtcbiAgY29uc3QgYWNjZXNzX3Rva2VuID0gYXdhaXQgYWRtaW4uYXV0aCgpLmNyZWF0ZUN1c3RvbVRva2VuKHVpZCwgY2xhaW1zKTtcblxuICBjb25zdCBjdXN0b21Ub2tlbiA9IHtcbiAgICBhY2Nlc3NfdG9rZW5cbiAgfTtcblxuICBpZiAob2ZmbGluZVNjb3BlKSB7XG4gICAgY29uc3QgcmVmcmVzaF90b2tlbiA9IGF3YWl0IGNyZWF0ZUFuZFN0b3JlUmVmcmVzaFRva2VuKHVpZCk7XG4gICAgT2JqZWN0LmFzc2lnbihjdXN0b21Ub2tlbiwgeyByZWZyZXNoX3Rva2VuIH0pO1xuICB9XG5cbiAgcmV0dXJuIGN1c3RvbVRva2VuO1xufTtcblxuY29uc3QgcmVzdG9yZVRva2VuRm9yVWlkID0gYXN5bmMgKHVpZCwgcmVmcmVzaF90b2tlbikgPT4ge1xuICBjb25zdCBjdXN0b21Ub2tlbiA9IGF3YWl0IGNyZWF0ZVRva2VuRm9yVWlkKHVpZCk7XG4gIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBjdXN0b21Ub2tlbiwgeyByZWZyZXNoX3Rva2VuIH0pO1xufTtcblxuLyoqXG4gKiBDcmVhdGVzIGEgYmFzaWMgdXNlciByZWNvcmRgXG4gKiBAcGFyYW0ge1N0cmluZ30gdXNlclxuICogQHJldHVybnMge1Byb21pc2V9XG4gKi9cbmNvbnN0IGluaXRpYWxpemVVc2VyID0gdXNlciA9PlxuICBkYlxuICAgIC5jb2xsZWN0aW9uKCd1c2VycycpXG4gICAgLmRvYyh1c2VyLnVpZClcbiAgICAuc2V0KHtcbiAgICAgIGRpc3BsYXlOYW1lOiB1c2VyLmRpc3BsYXlOYW1lLFxuICAgICAgcGhvdG9Vcmw6IG51bGwsXG4gICAgICB1aWQ6IHVzZXIudWlkLFxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICB2ZXJpZmllZDogZmFsc2VcbiAgICB9KTtcblxuY29uc3QgYmFzaWNBdXRoZW50aWNhdGlvbiA9IChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB0b2tlbiA9IHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24uc3BsaXQoJyAnKVsxXTtcbiAgbG9nZ2luZy5pbmZvKCdCYXNpYyBUb2tlbicsIHRva2VuKTtcbiAgY29uc3QgYnVmID0gQnVmZmVyLmZyb20odG9rZW4sICdiYXNlNjQnKTtcbiAgY29uc3QgW3VzZXJuYW1lLCBwYXNzd29yZF0gPSBidWYudG9TdHJpbmcoKS5zcGxpdCgnOicpO1xuICBjb25zdCBvZmZsaW5lU2NvcGUgPSB0cnVlO1xuICBsb2dnaW5nLmluZm8oJ0F0dGVtcHRpbmcgdG8gcGVyZm9ybSBiYXNpYyBhdXRoZW50aWNhdGlvbicsIHVzZXJuYW1lKTtcbiAgYWRtaW5cbiAgICAuYXV0aCgpXG4gICAgLnNpZ25JbldpdGhFbWFpbEFuZFBhc3N3b3JkKHVzZXJuYW1lLCBwYXNzd29yZClcbiAgICAudGhlbihjcmVkZW50aWFsID0+IHtcbiAgICAgIGxvZ2dpbmcuaW5mbygnVXNlciBzaWduZWQgaW4nLCB1c2VybmFtZSk7XG4gICAgICBjb25zdCB7IHVzZXIgfSA9IGNyZWRlbnRpYWw7XG4gICAgICByZXR1cm4gY3JlYXRlVG9rZW5Gb3JVaWQodXNlci51aWQsIG9mZmxpbmVTY29wZSk7XG4gICAgfSlcbiAgICAudGhlbihjdXN0b21Ub2tlbiA9PiB7XG4gICAgICByZXMuc2VuZCgyMDAsIGN1c3RvbVRva2VuKTtcbiAgICB9KVxuICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICByZXMuc2VuZCg0MDEsIHsgZXJyOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgIH0pO1xufTtcblxuY29uc3QgdG9rZW5BdXRoZW50aWNhdGlvbiA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICB0cnkge1xuICAgIC8vIEFzIGFuIGFkbWluLCB0aGUgYXBwIGhhcyBhY2Nlc3MgdG8gcmVhZCBhbmQgd3JpdGUgYWxsIGRhdGEsIHJlZ2FyZGxlc3Mgb2YgU2VjdXJpdHkgUnVsZXNcbiAgICBjb25zdCB0b2tlbiA9IHF1ZXJ5c3RyaW5nLnBhcnNlKHJlcS5ib2R5KS5yZWZyZXNoX3Rva2VuO1xuXG4gICAgY29uc3Qgc25hcHNob3QgPSBhd2FpdCBkYlxuICAgICAgLmNvbGxlY3Rpb24oJ3JlZnJlc2hUb2tlbicpXG4gICAgICAud2hlcmUoJ3Rva2VuJywgJz09JywgdG9rZW4pXG4gICAgICAubGltaXQoMSlcbiAgICAgIC5nZXQoKTtcblxuICAgIGlmIChzbmFwc2hvdC5kb2NzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHsgdWlkIH0gPSBzbmFwc2hvdC5kb2NzWzBdLmRhdGEoKTtcbiAgICAgIGNvbnN0IGN1c3RvbVRva2VuID0gYXdhaXQgcmVzdG9yZVRva2VuRm9yVWlkKHVpZCwgdG9rZW4pO1xuICAgICAgcmV0dXJuIHJlcy5zZW5kKDIwMCwgY3VzdG9tVG9rZW4pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzLnNlbmQoNDAxLCB7IGVycjogJ0ludmFsaWQgcmVmcmVzaCB0b2tlbicgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIHJlcy5zZW5kKDQwMSwgeyBlcnI6IGVycm9yLm1lc3NhZ2UgfSk7XG4gIH1cbn07XG5cbmNvbnN0IGF1dG9BY2NlcHRXb3Jrc3BhY2VJbnZpdGVzID0gYXN5bmMgKGVtYWlsLCB1aWQpID0+IHtcbiAgY29uc3QgcXVlcnlTbmFwc2hvdCA9IGF3YWl0IGRiXG4gICAgLmNvbGxlY3Rpb24oJ2ludml0ZXMnKVxuICAgIC53aGVyZSgnZW1haWwnLCAnPT0nLCBlbWFpbClcbiAgICAud2hlcmUoJ3N0YXR1cycsICc9PScsICdwZW5kaW5nJylcbiAgICAuZ2V0KCk7XG5cbiAgLy8gd2UgaGF2ZSBwZW5kaW5nIGludml0ZXNcbiAgaWYgKCFxdWVyeVNuYXBzaG90LmVtcHR5KSB7XG4gICAgcXVlcnlTbmFwc2hvdC5mb3JFYWNoKGFzeW5jIGludml0ZURvYyA9PiB7XG4gICAgICAvLyAxLiBnZXQgb3VyIGludml0ZVxuICAgICAgY29uc3QgaW52aXRlID0gaW52aXRlRG9jLmRhdGEoKTtcbiAgICAgIGNvbnN0IHdvcmtzcGFjZUlkID0gaW52aXRlLndvcmtzcGFjZUlkO1xuXG4gICAgICAvLyAyLiBnZXQgb3VyIHdvcmtzcGFjZVxuICAgICAgY29uc3Qgd29ya3NwYWNlRG9jID0gYXdhaXQgZGJcbiAgICAgICAgLmNvbGxlY3Rpb24oJ3dvcmtzcGFjZScpXG4gICAgICAgIC5kb2Mod29ya3NwYWNlSWQpXG4gICAgICAgIC5nZXQoKTtcbiAgICAgIGNvbnN0IHdvcmtzcGFjZSA9IHdvcmtzcGFjZURvYy5kYXRhKCk7XG5cbiAgICAgIC8vIDMuIGFkZCBvdXIgdXNlciB0byB0aGUgd29ya3NwYWNlXG4gICAgICB3b3Jrc3BhY2UudXNlcnNbdWlkXSA9IHRydWU7XG4gICAgICB3b3Jrc3BhY2VEb2MucmVmLnVwZGF0ZSh3b3Jrc3BhY2UpO1xuXG4gICAgICAvLyA0LiBDaGFuZ2Ugb3VyIGludml0ZSBzdGF0dXNcbiAgICAgIGludml0ZS5zdGF0dXMgPSAnYWNjZXB0LnJldmlldyc7XG4gICAgICBpbnZpdGVEb2MucmVmLnVwZGF0ZShpbnZpdGUpO1xuXG4gICAgICAvLyA1LiBzZW5kIGFuIGVtYWlsXG4gICAgICBlbWFpbE5vdGlmeS5hdXRvQWNjZXB0V29ya3NwYWNlSW52aXRlcyhpbnZpdGUuZW1haWwsIHdvcmtzcGFjZS5uYW1lKTtcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gdWlkO1xufTtcblxuY29uc3Qgc2lnbnVwVXNlciA9IChlbWFpbCwgcGFzc3dvcmQsIGRpc3BsYXlOYW1lKSA9PiB7XG4gIGNvbnN0IG9mZmxpbmVTY29wZSA9IHRydWU7XG4gIHJldHVybiBhZG1pblxuICAgIC5hdXRoKClcbiAgICAuY3JlYXRlVXNlcih7XG4gICAgICBlbWFpbCxcbiAgICAgIHBhc3N3b3JkLFxuICAgICAgZGlzcGxheU5hbWVcbiAgICB9KVxuICAgIC50aGVuKGNyZWRlbnRpYWwgPT4gaW5pdGlhbGl6ZVVzZXIoY3JlZGVudGlhbCkudGhlbigoKSA9PiBjcmVkZW50aWFsLnVpZCkpXG4gICAgLnRoZW4odWlkID0+IGF1dG9BY2NlcHRXb3Jrc3BhY2VJbnZpdGVzKGVtYWlsLCB1aWQpKVxuICAgIC50aGVuKHVpZCA9PiBjcmVhdGVUb2tlbkZvclVpZCh1aWQsIG9mZmxpbmVTY29wZSkpO1xufTtcblxuY29uc3QgaXNVc2VyID0gYXN5bmMgZW1haWwgPT4ge1xuICBjb25zdCBxdWVyeVNuYXBzaG90ID0gYXdhaXQgZGJcbiAgICAuY29sbGVjdGlvbigndXNlcnMnKVxuICAgIC53aGVyZSgnZW1haWwnLCAnPT0nLCBlbWFpbClcbiAgICAubGltaXQoMSlcbiAgICAuZ2V0KCk7XG5cbiAgcmV0dXJuICFxdWVyeVNuYXBzaG90LmVtcHR5O1xufTtcblxuY29uc3QgYmVhcmVyVG9VaWQgPSBhc3luYyBhdXRob3JpemF0aW9uQmVhcmVyID0+IHtcbiAgaWYgKFxuICAgICFfLmlzTmlsKGF1dGhvcml6YXRpb25CZWFyZXIpICYmXG4gICAgYXV0aG9yaXphdGlvbkJlYXJlci50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoJ2JlYXJlcicpXG4gICkge1xuICAgIGNvbnN0IGlkVG9rZW4gPSBhdXRob3JpemF0aW9uQmVhcmVyLnNwbGl0KCcgJylbMV07XG4gICAgcmV0dXJuIGFkbWluXG4gICAgICAuYXV0aCgpXG4gICAgICAudmVyaWZ5SWRUb2tlbihpZFRva2VuKVxuICAgICAgLnRoZW4oZGVjb2RlZFRva2VuID0+IGRlY29kZWRUb2tlbi51aWQpO1xuICB9XG5cbiAgcmV0dXJuIG51bGw7XG59O1xuXG5jb25zdCBpbnZpdGVVc2VycyA9IGFzeW5jIChlbWFpbHMsIHdvcmtzcGFjZUlkLCBjcmVhdG9yVWlkKSA9PiB7XG4gIGNvbnN0IHdvcmtzcGFjZURvYyA9IGF3YWl0IGRiXG4gICAgLmNvbGxlY3Rpb24oJ3dvcmtzcGFjZScpXG4gICAgLmRvYyh3b3Jrc3BhY2VJZClcbiAgICAuZ2V0KCk7XG5cbiAgaWYgKCF3b3Jrc3BhY2VEb2MuZXhpc3RzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCd3b3Jrc3BhY2UgZG9lcyBub3QgZXhpc3QnKTtcbiAgfVxuXG4gIGNvbnN0IHdvcmtzcGFjZVJlY29yZCA9IHdvcmtzcGFjZURvYy5kYXRhKCk7XG5cbiAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgIGVtYWlscy5tYXAoYXN5bmMgZW1haWwgPT4ge1xuICAgICAgLy8gY2hlY2sgaWYgd2UgYWxyZWFkeSBoYXZlIGFuIGludml0ZSBmb3IgdGhpcyB1c2VyIGFuZCB3b3Jrc3BhY2UgaWRcbiAgICAgIGNvbnN0IGludml0ZUVtYWlsVG9Xb3Jrc3BhY2VSZWYgPSBhd2FpdCBkYlxuICAgICAgICAuY29sbGVjdGlvbignaW52aXRlcycpXG4gICAgICAgIC53aGVyZSgnZW1haWwnLCAnPT0nLCBlbWFpbClcbiAgICAgICAgLndoZXJlKCd3b3Jrc3BhY2VJZCcsICc9PScsIHdvcmtzcGFjZUlkKVxuICAgICAgICAuZ2V0KCk7XG5cbiAgICAgIGlmICghaW52aXRlRW1haWxUb1dvcmtzcGFjZVJlZi5lbXB0eSkge1xuICAgICAgICBsb2dnaW5nLmluZm8oXG4gICAgICAgICAgYFtBbHJlYWR5IGludml0ZWQgdG8gd29ya3NwYWNlXSAke2NyZWF0b3JVaWR9IC0gQXR0ZW1wdGVkIHRvIGludml0ZSB1c2VyIFske2VtYWlsfV0gdG8gJHt3b3Jrc3BhY2VJZH1gXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gY2hlY2sgaWYgd2UgaGF2ZSBhIHVzZXIgZm9yIHRoaXMgZW1haWxcbiAgICAgIGNvbnN0IHVzZXJRdWVyeVNuYXBzaG90ID0gYXdhaXQgZGJcbiAgICAgICAgLmNvbGxlY3Rpb24oJ3VzZXJzJylcbiAgICAgICAgLndoZXJlKCdlbWFpbCcsICc9PScsIGVtYWlsKVxuICAgICAgICAubGltaXQoMSlcbiAgICAgICAgLmdldCgpO1xuICAgICAgY29uc3QgdXNlckV4aXN0cyA9ICF1c2VyUXVlcnlTbmFwc2hvdC5lbXB0eTtcblxuICAgICAgLy8gY3JlYXRlIGEgbmV3IGludml0ZSBmb3IgdGhpcyB1c2VyXG4gICAgICBjb25zdCBpbnZpdGUgPSB7XG4gICAgICAgIGVtYWlsLFxuICAgICAgICB3b3Jrc3BhY2VJZCxcbiAgICAgICAgY3JlYXRlZDogYWRtaW4uZmlyZXN0b3JlLkZpZWxkVmFsdWUuc2VydmVyVGltZXN0YW1wKCksXG4gICAgICAgIHN0YXR1czogdXNlckV4aXN0cyA/ICdhY2NlcHQucmV2aWV3JyA6ICdwZW5kaW5nJyxcbiAgICAgICAgaW52aXRlZEJ5OiBjcmVhdG9yVWlkXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCBkYlxuICAgICAgICAuY29sbGVjdGlvbignaW52aXRlcycpXG4gICAgICAgIC5kb2MoKVxuICAgICAgICAuc2V0KGludml0ZSk7XG5cbiAgICAgIGlmICh1c2VyRXhpc3RzKSB7XG4gICAgICAgIHVzZXJRdWVyeVNuYXBzaG90LmZvckVhY2goYXN5bmMgdXNlckRvYyA9PiB7XG4gICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJEb2MuZGF0YSgpO1xuICAgICAgICAgIC8vIHRoaXMgaXMgYSBzZWNvbmRhcnkgY2hlY2sgdGhhdCBzaG91bGQgYmUgbW9yZSByYXJlLCBob3dldmVyXG4gICAgICAgICAgLy8gaWYgd2Ugbm8gbG9uZ2VyIGhhdmUgYW4gaW52aXRlIHJlY29yZCwgYXQgbWluaW11bSBjaGVjayB0aGUgd29ya3NwYWNlIHRvXG4gICAgICAgICAgLy8gc2VlIGlmIHRoZSB1c2VyIGlzIHBhcnQgb2YgaXRcbiAgICAgICAgICBpZiAoXy5oYXMod29ya3NwYWNlUmVjb3JkLnVzZXJzLCB1c2VyLnVpZCkpIHtcbiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhcbiAgICAgICAgICAgICAgYFtBbHJlYWR5IGluIHdvcmtzcGFjZV0gJHtjcmVhdG9yVWlkfSAtIEF0dGVtcHRlZCB0byBpbnZpdGUgdXNlciBbJHtlbWFpbH1dIHRvICR7d29ya3NwYWNlSWR9YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB3b3Jrc3BhY2VSZWNvcmQudXNlcnNbdXNlci51aWRdID0ge1xuICAgICAgICAgICAgcm9sZTogJ2NvbGxhYm9yYXRvcicsXG4gICAgICAgICAgICBjcmVhdGVkOiBhZG1pbi5maXJlc3RvcmUuRmllbGRWYWx1ZS5zZXJ2ZXJUaW1lc3RhbXAoKVxuICAgICAgICAgIH07XG4gICAgICAgICAgYXdhaXQgd29ya3NwYWNlRG9jLnJlZi51cGRhdGUod29ya3NwYWNlUmVjb3JkKTtcblxuICAgICAgICAgIC8vIHVwZ3JhZGUgYWxsIG9mIHRoZSBldmVudHNcbiAgICAgICAgICBhd2FpdCB3b3Jrc3BhY2VIZWxwZXIudXBkYXRlRXZlbnRzRm9yV29ya3NwYWNlSWQoXG4gICAgICAgICAgICB3b3Jrc3BhY2VEb2MuaWQsXG4gICAgICAgICAgICB1c2VyRG9jLmlkXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIDIuIGFkZCB0aGUgd29ya3NwYWNlIHRvIHRoZSB1c2VyIGFjY291bnRcbiAgICAgICAgICBhd2FpdCB1cGRhdGVVc2VyV29ya3NwYWNlKHVzZXJEb2MuaWQsIHdvcmtzcGFjZURvYy5pZCk7XG5cbiAgICAgICAgICAvLyBhZGQgdG8gd29ya3NwYWNlIGlmIGl0cyBhbiBleGlzdGluZyB1c2VyIGFuZCBub3RpZnkgdGhlbSB0aGF0IHRoZXkndmUgYmVlbiBhZGRlZFxuICAgICAgICAgIGxvZ2dpbmcuaW5mbyhcbiAgICAgICAgICAgIGBbRXhpc3RpbmcgdXNlciBpbnZpdGVkXSAke2NyZWF0b3JVaWR9IC0gQWRkZWQgWyR7ZW1haWx9XSB0byAke3dvcmtzcGFjZUlkfWBcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgcmV0dXJuIGVtYWlsTm90aWZ5LmF1dG9BY2NlcHRXb3Jrc3BhY2VJbnZpdGVzKFxuICAgICAgICAgICAgZW1haWwsXG4gICAgICAgICAgICB3b3Jrc3BhY2VSZWNvcmQubmFtZVxuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdGhpcyBpcyBhIGJyYW5kIG5ldyB1c2VyLCBzZW5kIHRoZSBhcHByb3ByaWF0ZSBlbWFpbFxuICAgICAgICBsb2dnaW5nLmluZm8oXG4gICAgICAgICAgYFtOZXcgdXNlciBpbnZpdGVkXSAke2NyZWF0b3JVaWR9IC0gQWRkZWQgWyR7ZW1haWx9XSB0byAke3dvcmtzcGFjZUlkfWBcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gZW1haWxOb3RpZnkuaW52aXRlTmV3VXNlclRvV29ya3NwYWNlKFxuICAgICAgICAgIGVtYWlsLFxuICAgICAgICAgIHdvcmtzcGFjZVJlY29yZC5uYW1lXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSlcbiAgKTtcbn07XG5cbmNvbnN0IHVwZGF0ZVVzZXJXb3Jrc3BhY2UgPSBhc3luYyAodWlkLCB3b3Jrc3BhY2VJZCkgPT4ge1xuICBpZiAoXy5pc05pbCh1aWQpIHx8IF8uaXNOaWwod29ya3NwYWNlSWQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCd1aWQgb3Igd29ya3NwYWNlaWQgY2Fubm90IGJlIG51bGwnKTtcbiAgfVxuXG4gIGNvbnN0IGRvYyA9IGF3YWl0IGRiXG4gICAgLmNvbGxlY3Rpb24oJ3VzZXJzJylcbiAgICAuZG9jKHVpZClcbiAgICAuZ2V0KCk7XG4gIGNvbnN0IHVzZXJSZWNvcmQgPSBkb2MuZGF0YSgpO1xuXG4gIHVzZXJSZWNvcmQud29ya3NwYWNlcyA9IE9iamVjdC5hc3NpZ24oe30sIHVzZXJSZWNvcmQud29ya3NwYWNlcywge1xuICAgIFt3b3Jrc3BhY2VJZF06IHRydWVcbiAgfSk7XG5cbiAgcmV0dXJuIGRvYy5yZWYudXBkYXRlKHVzZXJSZWNvcmQpO1xufTtcblxuY29uc3QgY3JlYXRlV29ya3NwYWNlID0gYXN5bmMgKG5hbWUsIHVzZXJJZCkgPT4ge1xuICBjb25zdCB1c2VyRG9jID0gYXdhaXQgZGJcbiAgICAuY29sbGVjdGlvbigndXNlcnMnKVxuICAgIC5kb2ModXNlcklkKVxuICAgIC5nZXQoKTtcblxuICBpZiAoIXVzZXJEb2MuZXhpc3RzKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihgVXNlciAke3VzZXJJZH0gZG9lcyBub3QgZXhpc3RgKSk7XG4gIH1cbiAgY29uc3QgdXNlciA9IHVzZXJEb2MuZGF0YSgpO1xuXG4gIGxvZ2dpbmcuaW5mbyhgQ3JlYXRpbmcgYSBuZXcgd29ya3NwYWNlICR7bmFtZX1gKTtcbiAgLy8gMS4gY3JlYXRlIHRoZSB3b3Jrc3BhY2VcbiAgY29uc3Qgd29ya3NwYWNlRG9jUmVmID0gZGIuY29sbGVjdGlvbignd29ya3NwYWNlJykuZG9jKCk7XG4gIGNvbnN0IHdvcmtzcGFjZSA9IHtcbiAgICB1c2Vyczoge1xuICAgICAgW3VzZXJJZF06IHtcbiAgICAgICAgcm9sZTogJ2NyZWF0b3InLFxuICAgICAgICBjcmVhdGVkOiBhZG1pbi5maXJlc3RvcmUuRmllbGRWYWx1ZS5zZXJ2ZXJUaW1lc3RhbXAoKVxuICAgICAgfVxuICAgIH0sXG4gICAgbmFtZVxuICB9O1xuICBhd2FpdCB3b3Jrc3BhY2VEb2NSZWYuc2V0KHdvcmtzcGFjZSk7XG5cbiAgLy8gMi4gYWRkIHRoZSB3b3Jrc3BhY2UgdG8gdGhlIHVzZXIgYWNjb3VudFxuICBhd2FpdCB1cGRhdGVVc2VyV29ya3NwYWNlKHVzZXJJZCwgd29ya3NwYWNlRG9jUmVmLmlkKTtcblxuICAvLyAyLiBVcGdyYWRlIHRoZSB1c2VyXG4gIGNvbnN0IHVwZ3JhZGVkRXZlbnRzID0gYXdhaXQgd29ya3NwYWNlSGVscGVyLnVwZGF0ZUV2ZW50c0ZvcldvcmtzcGFjZUlkKFxuICAgIHdvcmtzcGFjZURvY1JlZi5pZCxcbiAgICB1c2VySWRcbiAgKTtcbiAgbG9nZ2luZy5pbmZvKGBVcGRhdGVkICR7dXBncmFkZWRFdmVudHN9IGZvciAke3VzZXJJZH0gYW5kIHdvcmtzcGFjZSAke25hbWV9YCk7XG5cbiAgLy8gMy4gc2VuZCBlbWFpbCB0aGF0IHdlIGhhdmUgY3JlYXRlZCBhIG5ldyB3b3Jrc3BhY2VcbiAgYXdhaXQgZW1haWxOb3RpZnkuY3JlYXRlV29ya3NwYWNlKHVzZXIuZW1haWwsIG5hbWUpO1xuXG4gIHJldHVybiB3b3Jrc3BhY2VEb2NSZWYuaWQ7XG59O1xuXG5jb25zdCBnZXREb21haW5zID0gYXN5bmMgcmVmcmVzaFRva2VuID0+IHtcbiAgY29uc3Qgc25hcHNob3QgPSBhd2FpdCBkYlxuICAgIC5jb2xsZWN0aW9uKCdyZWZyZXNoVG9rZW4nKVxuICAgIC53aGVyZSgndG9rZW4nLCAnPT0nLCByZWZyZXNoVG9rZW4pXG4gICAgLmdldCgpO1xuXG4gIGNvbnN0IHsgdWlkIH0gPSBzbmFwc2hvdC5kb2NzWzBdLmRhdGEoKTtcblxuICBjb25zdCB3b3Jrc3BhY2VTbmFwc2hvdCA9IGF3YWl0IGRiXG4gICAgLmNvbGxlY3Rpb24oJ3dvcmtzcGFjZScpXG4gICAgLndoZXJlKGB1c2Vycy4ke3VpZH0ucm9sZWAsICc+JywgJycpXG4gICAgLmdldCgpO1xuXG4gIGNvbnN0IGlkcyA9IFt7IHR5cGU6ICd1aWQnLCB2YWw6IHVpZCB9XTtcbiAgd29ya3NwYWNlU25hcHNob3QuZm9yRWFjaChkb2MgPT5cbiAgICBpZHMucHVzaCh7IHR5cGU6ICd3b3Jrc3BhY2UnLCB2YWw6IGRvYy5pZCB9KVxuICApO1xuXG4gIGNvbnN0IGV2ZW50c1JlZiA9IGRiLmNvbGxlY3Rpb24oJ2V2ZW50cycpO1xuICBjb25zdCBzaXRlc1F1ZXJpZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICBfLmNoYWluKGlkcylcbiAgICAgIC5tYXAoKHsgdHlwZSwgdmFsIH0pID0+XG4gICAgICAgIGV2ZW50c1JlZlxuICAgICAgICAgIC53aGVyZSh0eXBlID09PSAndWlkJyA/IGBtZXRhLnVzZXJJZGAgOiAnbWV0YS53b3Jrc3BhY2VJZCcsICc9PScsIHZhbClcbiAgICAgICAgICAuZ2V0KClcbiAgICAgIClcbiAgICAgIC52YWx1ZSgpXG4gICk7XG5cbiAgY29uc3Qgc2l0ZXMgPSBfLmNoYWluKHNpdGVzUXVlcmllcylcbiAgICAuZmxhdE1hcChxdWVyeVNuYXBzaG90ID0+IHtcbiAgICAgIGNvbnN0IGRvY3MgPSBbXTtcbiAgICAgIHF1ZXJ5U25hcHNob3QuZm9yRWFjaChkb2MgPT4gZG9jcy5wdXNoKGRvYykpO1xuICAgICAgcmV0dXJuIGRvY3M7XG4gICAgfSlcbiAgICAubWFwKGRvYyA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gZG9jLmRhdGEoKTtcbiAgICAgIHJldHVybiBkYXRhLnVybC5ob3N0bmFtZTtcbiAgICB9KVxuICAgIC51bmlxKClcbiAgICAudmFsdWUoKTtcblxuICByZXR1cm4gc2l0ZXM7XG59O1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gIHJldHJpZXZlQ2xhaW1zRm9yVWlkLFxuICBjcmVhdGVBbmRTdG9yZVJlZnJlc2hUb2tlbixcbiAgY3JlYXRlVG9rZW5Gb3JVaWQsXG4gIHJlc3RvcmVUb2tlbkZvclVpZCxcbiAgYmFzaWNBdXRoZW50aWNhdGlvbixcbiAgdG9rZW5BdXRoZW50aWNhdGlvbixcbiAgaW5pdGlhbGl6ZVVzZXIsXG4gIHNpZ251cFVzZXIsXG4gIGlzVXNlcixcbiAgYmVhcmVyVG9VaWQsXG4gIGludml0ZVVzZXJzLFxuICBjcmVhdGVXb3Jrc3BhY2UsXG4gIGdldERvbWFpbnNcbn07XG4iXX0=